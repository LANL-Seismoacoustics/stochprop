<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>stochprop.propagation &mdash; stochprop 0.1 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> stochprop
            <img src="../../_static/lanl_logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../userguide.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authorship.html">Authorship &amp; References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analysis.html">Stochastic Propagation Analysis</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">stochprop</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">stochprop.propagation</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for stochprop.propagation</h1><div class="highlight"><pre>
<span></span><span class="c1"># propagation.py</span>
<span class="c1">#</span>
<span class="c1"># Run infraga-accel-3d or NCPAprop&#39;s modess to generate predictions to</span>
<span class="c1"># use for constructing stochastic propagation models</span>
<span class="c1">#</span>
<span class="c1"># Philip Blom (pblom@lanl.gov)</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">imp</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pyproj</span> <span class="kn">import</span> <span class="n">Geod</span>

<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">simps</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span><span class="p">,</span> <span class="n">RectBivariateSpline</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span><span class="p">,</span> <span class="n">gaussian_kde</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">savgol_filter</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">gamma</span>

<span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="k">as</span> <span class="nn">cm</span>
<span class="kn">import</span> <span class="nn">matplotlib.image</span> <span class="k">as</span> <span class="nn">mpimg</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.ticker</span> <span class="k">as</span> <span class="nn">mticker</span>
<span class="kn">from</span> <span class="nn">matplotlib.colorbar</span> <span class="kn">import</span> <span class="n">ColorbarBase</span>

<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>

<span class="kn">import</span> <span class="nn">cartopy.crs</span> <span class="k">as</span> <span class="nn">crs</span>
<span class="kn">import</span> <span class="nn">cartopy.feature</span> <span class="k">as</span> <span class="nn">cfeature</span>
<span class="kn">from</span> <span class="nn">cartopy.mpl.gridliner</span> <span class="kn">import</span> <span class="n">LONGITUDE_FORMATTER</span><span class="p">,</span> <span class="n">LATITUDE_FORMATTER</span>

<span class="n">sph_proj</span> <span class="o">=</span> <span class="n">Geod</span><span class="p">(</span><span class="n">ellps</span><span class="o">=</span><span class="s1">&#39;sphere&#39;</span><span class="p">)</span>

<span class="n">map_proj</span> <span class="o">=</span> <span class="n">crs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()</span>
<span class="n">resol</span> <span class="o">=</span> <span class="s1">&#39;100m&#39;</span>  <span class="c1"># use data at this scale (not working at the moment)</span>


<span class="c1"># ############################## #</span>
<span class="c1">#  Plotting the Effective Sound  #</span>
<span class="c1">#   Speed Ratio for Seasonality  #</span>
<span class="c1"># ############################## #</span>

<span class="k">def</span> <span class="nf">_plot_ess_ratio</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">datetimes</span><span class="p">,</span> <span class="n">grnd_index</span><span class="p">,</span> <span class="n">results_path</span><span class="p">,</span> <span class="n">include_ns</span><span class="p">,</span> <span class="n">show_title</span><span class="p">,</span> <span class="n">output_header</span><span class="p">):</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">})</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Computing effective sound speed ratio for each day-of-year...&quot;</span><span class="p">)</span>
    <span class="n">f1</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">52</span><span class="p">)</span>
    <span class="n">ax1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">ax1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="n">ax1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Peak ESS Ratio&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Week of Year&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Altitude [km]&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show_title</span><span class="p">:</span>
        <span class="n">ax1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Effective Sound Speed (ESS) Ratio Analysis </span><span class="se">\n</span><span class="s2"> Eastward (blue), Westward (red)&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">include_ns</span><span class="p">:</span>
        <span class="n">f2</span><span class="p">,</span> <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">52</span><span class="p">)</span>
        <span class="n">ax2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">ax2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">ax2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Peak ESS Ratio&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Week of Year&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Altitude [km]&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show_title</span><span class="p">:</span>
            <span class="n">ax2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Effective Sound Speed (ESS) Ratio Analysis </span><span class="se">\n</span><span class="s2"> Northward (purple), Southward (orange)&quot;</span><span class="p">)</span>

    <span class="n">eff_sndspd_pk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">365</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">yday</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">{:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">365</span><span class="p">)]):</span>

        <span class="n">yday_mask</span> <span class="o">=</span> <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="n">dt_n</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">datetime</span><span class="p">)</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()</span><span class="o">.</span><span class="n">tm_yday</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="k">for</span> <span class="n">dt_n</span> <span class="ow">in</span> <span class="n">datetimes</span><span class="p">]</span>
        <span class="n">eff_sndspd_ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">datetimes</span><span class="p">[</span><span class="n">yday_mask</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">z0</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">An</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">yday_mask</span><span class="p">]):</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">An</span><span class="p">[</span><span class="mi">1</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">z0</span><span class="p">):</span><span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">z0</span><span class="p">)]</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">An</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">z0</span><span class="p">):</span><span class="mi">3</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">z0</span><span class="p">)]</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">An</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">z0</span><span class="p">):</span><span class="mi">4</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">z0</span><span class="p">)]</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">An</span><span class="p">[</span><span class="mi">4</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">z0</span><span class="p">):</span><span class="mi">5</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">z0</span><span class="p">)]</span>

            <span class="n">c_eff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">0.14</span> <span class="o">*</span> <span class="n">p</span> <span class="o">/</span> <span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mf">90.0</span><span class="p">))</span> <span class="o">*</span> <span class="n">u</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mf">90.0</span><span class="p">))</span> <span class="o">*</span> <span class="n">v</span>
            <span class="n">eff_sndspd_ratio</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_eff</span> <span class="o">/</span> <span class="n">c_eff</span><span class="p">[</span><span class="n">grnd_index</span><span class="p">]</span>
            
            <span class="n">c_eff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">0.14</span> <span class="o">*</span> <span class="n">p</span> <span class="o">/</span> <span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="o">-</span><span class="mf">90.0</span><span class="p">))</span> <span class="o">*</span> <span class="n">u</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="o">-</span><span class="mf">90.0</span><span class="p">))</span> <span class="o">*</span> <span class="n">v</span>
            <span class="n">eff_sndspd_ratio</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_eff</span> <span class="o">/</span> <span class="n">c_eff</span><span class="p">[</span><span class="n">grnd_index</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">include_ns</span><span class="p">:</span>
                <span class="n">c_eff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">0.14</span> <span class="o">*</span> <span class="n">p</span> <span class="o">/</span> <span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span> <span class="o">*</span> <span class="n">u</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span> <span class="o">*</span> <span class="n">v</span>
                <span class="n">eff_sndspd_ratio</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_eff</span> <span class="o">/</span> <span class="n">c_eff</span><span class="p">[</span><span class="n">grnd_index</span><span class="p">]</span>
                
                <span class="n">c_eff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">0.14</span> <span class="o">*</span> <span class="n">p</span> <span class="o">/</span> <span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mf">180.0</span><span class="p">))</span> <span class="o">*</span> <span class="n">u</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mf">180.0</span><span class="p">))</span> <span class="o">*</span> <span class="n">v</span>
                <span class="n">eff_sndspd_ratio</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_eff</span> <span class="o">/</span> <span class="n">c_eff</span><span class="p">[</span><span class="n">grnd_index</span><span class="p">]</span>

        <span class="n">plot_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">z0</span> <span class="o">&lt;</span> <span class="mf">100.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">eff_sndspd_ratio</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">plot_mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">im1</span> <span class="o">=</span> <span class="n">ax1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">yday</span><span class="p">)</span> <span class="o">/</span> <span class="mf">7.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">z0</span><span class="p">[</span><span class="n">plot_mask</span><span class="p">]),</span> <span class="n">z0</span><span class="p">[</span><span class="n">plot_mask</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">eff_sndspd_ratio</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">plot_mask</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">seismic_r</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1.1</span><span class="p">)</span>

        <span class="n">plot_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">z0</span> <span class="o">&lt;</span> <span class="mf">100.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">eff_sndspd_ratio</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">plot_mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ax1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">yday</span><span class="p">)</span> <span class="o">/</span> <span class="mf">7.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">z0</span><span class="p">[</span><span class="n">plot_mask</span><span class="p">]),</span> <span class="n">z0</span><span class="p">[</span><span class="n">plot_mask</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">eff_sndspd_ratio</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">plot_mask</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">seismic</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1.1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">eff_sndspd_ratio</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="mf">35.0</span> <span class="o">&lt;=</span> <span class="n">z0</span><span class="p">,</span> <span class="n">z0</span> <span class="o">&lt;=</span> <span class="mf">70.0</span><span class="p">)])</span>    

        <span class="k">if</span> <span class="n">include_ns</span><span class="p">:</span>
            <span class="n">plot_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">z0</span> <span class="o">&lt;</span> <span class="mf">100.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">eff_sndspd_ratio</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">plot_mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ax2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">yday</span><span class="p">)</span> <span class="o">/</span> <span class="mf">7.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">z0</span><span class="p">[</span><span class="n">plot_mask</span><span class="p">]),</span> <span class="n">z0</span><span class="p">[</span><span class="n">plot_mask</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">eff_sndspd_ratio</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">plot_mask</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">PuOr</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1.1</span><span class="p">)</span>

            <span class="n">plot_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">z0</span> <span class="o">&lt;</span> <span class="mf">100.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">eff_sndspd_ratio</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">plot_mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">im2</span> <span class="o">=</span> <span class="n">ax2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">yday</span><span class="p">)</span> <span class="o">/</span> <span class="mf">7.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">z0</span><span class="p">[</span><span class="n">plot_mask</span><span class="p">]),</span> <span class="n">z0</span><span class="p">[</span><span class="n">plot_mask</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">eff_sndspd_ratio</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">plot_mask</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">PuOr_r</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1.1</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
                <span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">eff_sndspd_ratio</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="mf">35.0</span> <span class="o">&lt;=</span> <span class="n">z0</span><span class="p">,</span> <span class="n">z0</span> <span class="o">&lt;=</span> <span class="mf">70.0</span><span class="p">)])</span>    

    <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">location</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">))</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([</span><span class="s1">&#39;1.1 (west)&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0&#39;</span><span class="p">,</span> <span class="s1">&#39;1.1 (east)&#39;</span><span class="p">])</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Effective Sound Speed (ESS) Ratio&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">include_ns</span><span class="p">:</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">location</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">))</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([</span><span class="s1">&#39;1.1 (south)&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0&#39;</span><span class="p">,</span> <span class="s1">&#39;1.1 (north)&#39;</span><span class="p">])</span>

    <span class="c1"># Output summary of ess_ratio unity crossings</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Eastward waveguide changes...&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">364</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Waveguide dissipates:&quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s1">&#39;20&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="s1">&#39;%y%j&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%B </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span> <span class="s2">&quot; (yday: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, week: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="mi">7</span><span class="p">)))</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Waveguide forms:&quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s1">&#39;20&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="s1">&#39;%y%j&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%B </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span> <span class="s2">&quot; (yday: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, week: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="mi">7</span><span class="p">)))</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Westward waveguide changes...&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">364</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Waveguide dissipates:&quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s1">&#39;20&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="s1">&#39;%y%j&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%B </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span> <span class="s2">&quot; (yday: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, week: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="mi">7</span><span class="p">)))</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Waveguide forms:&quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s1">&#39;20&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="s1">&#39;%y%j&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%B </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span> <span class="s2">&quot; (yday: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, week: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="mi">7</span><span class="p">)))</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">include_ns</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Northward waveguide changes...&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">364</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Waveguide dissipates:&quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s1">&#39;20&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="s1">&#39;%y%j&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%B </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span> <span class="s2">&quot; (yday: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, week: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="mi">7</span><span class="p">)))</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Waveguide forms:&quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s1">&#39;20&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="s1">&#39;%y%j&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%B </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span> <span class="s2">&quot; (yday: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, week: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="mi">7</span><span class="p">)))</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Southward waveguide changes...&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">364</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Waveguide dissipates:&quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s1">&#39;20&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="s1">&#39;%y%j&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%B </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span> <span class="s2">&quot; (yday: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, week: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="mi">7</span><span class="p">)))</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Waveguide forms:&quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s1">&#39;20&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="s1">&#39;%y%j&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%B </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span> <span class="s2">&quot; (yday: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, week: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="mi">7</span><span class="p">)))</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="n">ax1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">365.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">7.0</span><span class="p">,</span> <span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;-b&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>
    <span class="n">ax1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">365.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">7.0</span><span class="p">,</span> <span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;--r&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>
    <span class="n">ax1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">include_ns</span><span class="p">:</span>
        <span class="n">ax2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">365.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">7.0</span><span class="p">,</span> <span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>
        <span class="n">ax2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">365.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">7.0</span><span class="p">,</span> <span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>
        <span class="n">ax2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">results_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">results_path</span> <span class="o">+</span> <span class="s2">&quot;.summary.txt&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">output_header</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">output_file</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Eastward waveguide changes...&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">output_file</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">364</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Waveguide dissipates:&quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s1">&#39;20&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="s1">&#39;%y%j&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%B </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span> <span class="s2">&quot; (yday: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, week: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="mi">7</span><span class="p">)))</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">output_file</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Waveguide forms:&quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s1">&#39;20&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="s1">&#39;%y%j&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%B </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span> <span class="s2">&quot; (yday: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, week: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="mi">7</span><span class="p">)))</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">output_file</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Westward waveguide changes...&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">output_file</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">364</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Waveguide dissipates:&quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s1">&#39;20&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="s1">&#39;%y%j&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%B </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span> <span class="s2">&quot; (yday: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, week: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="mi">7</span><span class="p">)))</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">output_file</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Waveguide forms:&quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s1">&#39;20&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="s1">&#39;%y%j&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%B </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span> <span class="s2">&quot; (yday: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, week: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="mi">7</span><span class="p">)))</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">output_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">include_ns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Northward waveguide changes...&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">output_file</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">364</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Waveguide dissipates:&quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s1">&#39;20&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="s1">&#39;%y%j&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%B </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span> <span class="s2">&quot; (yday: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, week: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="mi">7</span><span class="p">)))</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">output_file</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Waveguide forms:&quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s1">&#39;20&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="s1">&#39;%y%j&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%B </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span> <span class="s2">&quot; (yday: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, week: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="mi">7</span><span class="p">)))</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">output_file</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Southward waveguide changes...&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">output_file</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">364</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">eff_sndspd_pk</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Waveguide dissipates:&quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s1">&#39;20&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="s1">&#39;%y%j&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%B </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span> <span class="s2">&quot; (yday: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, week: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="mi">7</span><span class="p">)))</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">output_file</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Waveguide forms:&quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s1">&#39;20&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="s1">&#39;%y%j&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%B </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span> <span class="s2">&quot; (yday: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, week: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="mi">7</span><span class="p">)))</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">output_file</span><span class="p">)</span>

        <span class="n">output_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">f1</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">results_path</span> <span class="o">+</span> <span class="s2">&quot;.ess-ratio.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">include_ns</span><span class="p">:</span>
            <span class="n">f2</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">results_path</span> <span class="o">+</span> <span class="s2">&quot;.ess-ratio.NS.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># ############################## #</span>
<span class="c1">#  Running infraga and NCPAprop  #</span>
<span class="c1">#     with multiple profiles     #</span>
<span class="c1"># ############################## #</span>
<div class="viewcode-block" id="run_infraga"><a class="viewcode-back" href="../../stochprop.propagation.html#stochprop.propagation.run_infraga">[docs]</a><span class="k">def</span> <span class="nf">run_infraga</span><span class="p">(</span><span class="n">profs_path</span><span class="p">,</span> <span class="n">results_file</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;*.met&quot;</span><span class="p">,</span> <span class="n">cpu_cnt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">geom</span><span class="o">=</span><span class="s2">&quot;3d&quot;</span><span class="p">,</span> <span class="n">bounces</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">inclinations</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">60.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">azimuths</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">180.0</span><span class="p">,</span> <span class="mf">180.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">],</span> <span class="n">freq</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">z_grnd</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">rng_max</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">src_loc</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">infraga_path</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">clean_up</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">prof_format</span><span class="o">=</span><span class="s2">&quot;zTuvdp&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the infraga -prop algorithm to compute path geometry</span>
<span class="sd">        statistics for BISL using a suite of specifications</span>
<span class="sd">        and combining results into single file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        profs_path: string</span>
<span class="sd">            Path to atmospheric specification files</span>
<span class="sd">        results_file: string</span>
<span class="sd">            Path and name of file where results will be written</span>
<span class="sd">        pattern: string</span>
<span class="sd">            Pattern identifying atmospheric specification within profs_path location</span>
<span class="sd">        cpu_cnt: int</span>
<span class="sd">            Number of threads to use in OpenMPI implementation.  None runs non-OpenMPI version of infraga</span>
<span class="sd">        geom: string</span>
<span class="sd">            Defines geometry of the infraga simulations (3d&quot; or &quot;sph&quot;)</span>
<span class="sd">        bounces: int</span>
<span class="sd">            Maximum number of ground reflections to consider in ray tracing</span>
<span class="sd">        inclinations: iterable object</span>
<span class="sd">            Iterable of starting, ending, and step for ray launch inclination</span>
<span class="sd">        azimuths: iterable object</span>
<span class="sd">            Iterable of starting, ending, and step for ray launch azimuths</span>
<span class="sd">        freq: float</span>
<span class="sd">            Frequency to use for Sutherland Bass absorption calculation</span>
<span class="sd">        z_grnd: float</span>
<span class="sd">            Elevation of the ground surface relative to sea level</span>
<span class="sd">        rng_max: float</span>
<span class="sd">            Maximum propagation range for propagation paths</span>
<span class="sd">        src_loc: iterable object</span>
<span class="sd">            The horizontal (latitude and longitude) and altitude of the source</span>
<span class="sd">        infraga_path: string</span>
<span class="sd">            Location of infraGA executables</span>
<span class="sd">        clean_up: boolean</span>
<span class="sd">            Flag to remove individual [..].arrival.dat files after combining</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">results_file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">results_file</span> <span class="o">+</span> <span class="s2">&quot; already exists  ---&gt;  Skipping infraGA/GeoAc ray tracing runs...&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="n">geom</span> <span class="o">==</span> <span class="s2">&quot;3d&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">geom</span> <span class="o">==</span> <span class="s2">&quot;sph&quot;</span><span class="p">)):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Incompatible geometry option for infraga: </span><span class="si">{}</span><span class="s2">.  Options are 3d&#39; and &#39;sph&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">profs_path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;/&quot;</span><span class="p">:</span>
                <span class="n">profs_path</span> <span class="o">=</span> <span class="n">profs_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
            <span class="n">dir_files</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">profs_path</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">dir_files</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
                    <span class="n">file_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">profs_path</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">file_id</span> <span class="o">+</span> <span class="s2">&quot;.arrivals.dat&quot;</span><span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;InfraGA/GeoAc arrivals for &quot;</span> <span class="o">+</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot; already finished...&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating ray paths for &quot;</span> <span class="o">+</span> <span class="n">file_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">cpu_cnt</span><span class="p">:</span>
                            <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;mpirun -np &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cpu_cnt</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">infraga_path</span> <span class="o">+</span> <span class="s2">&quot; infraga-accel-&quot;</span> <span class="o">+</span> <span class="n">geom</span> <span class="o">+</span> <span class="s2">&quot; -prop &quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">command</span> <span class="o">=</span> <span class="n">infraga_path</span> <span class="o">+</span> <span class="s2">&quot; infraga-&quot;</span> <span class="o">+</span> <span class="n">geom</span> <span class="o">+</span> <span class="s2">&quot; -prop &quot;</span>

                        <span class="n">command</span> <span class="o">=</span> <span class="n">command</span> <span class="o">+</span> <span class="n">profs_path</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">file_name</span>
                        <span class="n">command</span> <span class="o">=</span> <span class="n">command</span> <span class="o">+</span> <span class="s2">&quot; incl_min=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">inclinations</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; incl_max=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">inclinations</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; incl_step=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">inclinations</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                        <span class="n">command</span> <span class="o">=</span> <span class="n">command</span> <span class="o">+</span> <span class="s2">&quot; az_min=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">azimuths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; az_max=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">azimuths</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; az_step=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">azimuths</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">geom</span> <span class="o">==</span> <span class="s2">&quot;sph&quot;</span><span class="p">:</span>
                            <span class="n">command</span> <span class="o">=</span> <span class="n">command</span> <span class="o">+</span> <span class="s2">&quot; src_lat=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">src_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; src_lon=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">src_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">command</span> <span class="o">=</span> <span class="n">command</span> <span class="o">+</span> <span class="s2">&quot; src_alt=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">src_loc</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                        <span class="n">command</span> <span class="o">=</span> <span class="n">command</span> <span class="o">+</span> <span class="s2">&quot; freq=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; z_grnd=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">z_grnd</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; max_rng=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rng_max</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; prof_format=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">prof_format</span><span class="p">)</span>
                        <span class="n">command</span> <span class="o">=</span> <span class="n">command</span> <span class="o">+</span> <span class="s2">&quot; calc_amp=False&quot;</span> <span class="o">+</span> <span class="s2">&quot; bounces=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">bounces</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; write_rays=false&quot;</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="n">command</span> <span class="o">=</span> <span class="n">command</span> <span class="o">+</span> <span class="s2">&quot; &gt; /dev/null&quot;</span>

                        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;cat &quot;</span> <span class="o">+</span> <span class="n">profs_path</span> <span class="o">+</span> <span class="s2">&quot;/*.arrivals.dat &gt; &quot;</span> <span class="o">+</span> <span class="n">results_file</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">clean_up</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;rm &quot;</span>  <span class="o">+</span> <span class="n">profs_path</span> <span class="o">+</span> <span class="s2">&quot;/*.dat&quot;</span>
                <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="run_modess"><a class="viewcode-back" href="../../stochprop.propagation.html#stochprop.propagation.run_modess">[docs]</a><span class="k">def</span> <span class="nf">run_modess</span><span class="p">(</span><span class="n">profs_path</span><span class="p">,</span> <span class="n">results_path</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;*.met&quot;</span><span class="p">,</span> <span class="n">azimuths</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">180.0</span><span class="p">,</span> <span class="mf">180.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">],</span> <span class="n">freq</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">z_grnd</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">rng_max</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">ncpaprop_path</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">clean_up</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">keep_lossless</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cpu_cnt</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the NCPAprop normal mode methods to compute transmission</span>
<span class="sd">        loss values for a suite of atmospheric specifications at</span>
<span class="sd">        a set of frequency values</span>
<span class="sd">        </span>
<span class="sd">        Note: the methods here use the ncpaprop_v2 version that includes an option</span>
<span class="sd">        for --filetag that writes output into a specific location and enables</span>
<span class="sd">        simultaneous calculations via subprocess.popen()</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        profs_path: string</span>
<span class="sd">            Path to atmospheric specification files</span>
<span class="sd">        results_file: string</span>
<span class="sd">            Path and name of file where results will be written</span>
<span class="sd">        pattern: string</span>
<span class="sd">            Pattern identifying atmospheric specification within profs_path location</span>
<span class="sd">        azimuths: iterable object</span>
<span class="sd">            Iterable of starting, ending, and step for propagation azimuths</span>
<span class="sd">        freq: float</span>
<span class="sd">            Frequency for simulation</span>
<span class="sd">        z_grnd: float</span>
<span class="sd">            Elevation of the ground surface relative to sea level</span>
<span class="sd">        rng_max: float</span>
<span class="sd">            Maximum propagation range for propagation paths</span>
<span class="sd">        clean_up: boolean</span>
<span class="sd">            Flag to remove individual .nm files after combining</span>
<span class="sd">        keep_lossless: boolean</span>
<span class="sd">            Flag to keep the lossless (no absorption) results</span>
<span class="sd">        cpu_cnt : integer</span>
<span class="sd">            Number of CPUs to use in subprocess.popen loop for simultaneous calculations</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="n">dir_files</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">profs_path</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">results_path</span> <span class="o">+</span> <span class="s2">&quot;.nm&quot;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">results_path</span> <span class="o">+</span> <span class="s2">&quot;.nm already exists  ---&gt;  Skipping NCPAprop modess runs...&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running NCPAprop modess for atmospheric specifications in &quot;</span> <span class="o">+</span> <span class="n">profs_path</span><span class="p">)</span>
        <span class="n">command_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">dir_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">profs_path</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">freq</span> <span class="o">+</span> <span class="s2">&quot;Hz.nm&quot;</span><span class="p">):</span>
                <span class="n">command</span> <span class="o">=</span> <span class="n">ncpaprop_path</span> <span class="o">+</span> <span class="s2">&quot;Modess --multiprop --atmosfile &quot;</span> <span class="o">+</span> <span class="n">profs_path</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot; --freq &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;  --maxrange_km &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rng_max</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; --zground_km &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">z_grnd</span><span class="p">)</span> 
                <span class="n">command</span> <span class="o">=</span> <span class="n">command</span> <span class="o">+</span> <span class="s2">&quot; --azimuth_start &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">azimuths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; --azimuth_end &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">azimuths</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; --azimuth_step &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">azimuths</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">command</span> <span class="o">=</span> <span class="n">command</span> <span class="o">+</span> <span class="s2">&quot; --filetag &quot;</span> <span class="o">+</span> <span class="n">profs_path</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">%.3f</span><span class="s2">Hz&quot;</span> <span class="o">%</span> <span class="n">freq</span> <span class="o">+</span> <span class="s2">&quot; &gt; /dev/null&quot;</span>
                <span class="n">command_list</span> <span class="o">=</span> <span class="n">command_list</span> <span class="o">+</span> <span class="p">[</span><span class="n">command</span><span class="p">]</span>


        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">command_list</span><span class="p">),</span> <span class="n">cpu_cnt</span><span class="p">):</span>              
            <span class="k">if</span> <span class="n">cpu_cnt</span><span class="o">==</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">command_list</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Running NCPAprop modess for sample &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;of &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">command_list</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="n">cpu_cnt</span><span class="o">==</span><span class="mi">2</span> <span class="ow">or</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">command_list</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Running NCPAprop modess for samples &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; of &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">command_list</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Running NCPAprop modess for samples &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">cpu_cnt</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">command_list</span><span class="p">)))</span> <span class="o">+</span> <span class="s2">&quot; of &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">command_list</span><span class="p">)))</span>

            <span class="n">procs_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">command_list</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">j</span> <span class="o">+</span> <span class="n">cpu_cnt</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">proc</span> <span class="ow">in</span> <span class="n">procs_list</span><span class="p">:</span>
                <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
                <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">rng_max</span> <span class="o">&gt;</span> <span class="mi">1001</span><span class="p">:</span>
            <span class="n">command_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">dir_files</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">profs_path</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">freq</span> <span class="o">+</span> <span class="s2">&quot;Hz.nm&quot;</span><span class="p">):</span>
                    <span class="n">command</span> <span class="o">=</span> <span class="n">ncpaprop_path</span> <span class="o">+</span> <span class="s2">&quot;Modess --multiprop --atmosfile &quot;</span> <span class="o">+</span> <span class="n">profs_path</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot; --freq &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
                    <span class="n">command</span> <span class="o">=</span> <span class="n">command</span> <span class="o">+</span> <span class="s2">&quot;  --maxrange_km &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">rng_max</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot; --Nrng_steps &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">rng_max</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot; --zground_km &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">z_grnd</span><span class="p">)</span>
                    <span class="n">command</span> <span class="o">=</span> <span class="n">command</span> <span class="o">+</span> <span class="s2">&quot; --azimuth_start &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">azimuths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; --azimuth_end &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">azimuths</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; --azimuth_step &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">azimuths</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">command</span> <span class="o">=</span> <span class="n">command</span> <span class="o">+</span> <span class="s2">&quot; --filetag &quot;</span> <span class="o">+</span> <span class="n">profs_path</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">%.3f</span><span class="s2">Hz-temp&quot;</span> <span class="o">%</span> <span class="n">freq</span> <span class="o">+</span> <span class="s2">&quot; &gt; /dev/null&quot;</span>
                    <span class="n">command_list</span> <span class="o">=</span> <span class="n">command_list</span> <span class="o">+</span> <span class="p">[</span><span class="n">command</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">command_list</span><span class="p">),</span> <span class="n">cpu_cnt</span><span class="p">):</span>              
                <span class="k">if</span> <span class="n">cpu_cnt</span><span class="o">==</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">command_list</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Running NCPAprop modess near-source for sample &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;of &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">command_list</span><span class="p">)))</span>
                <span class="k">elif</span> <span class="n">cpu_cnt</span><span class="o">==</span><span class="mi">2</span> <span class="ow">or</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">command_list</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Running NCPAprop modess near-source for samples &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; of &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">command_list</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Running NCPAprop modess near-source for samples &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">cpu_cnt</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">command_list</span><span class="p">)))</span> <span class="o">+</span> <span class="s2">&quot; of &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">command_list</span><span class="p">)))</span>

                <span class="n">procs_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">command_list</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">j</span> <span class="o">+</span> <span class="n">cpu_cnt</span><span class="p">]]</span>
                <span class="k">for</span> <span class="n">proc</span> <span class="ow">in</span> <span class="n">procs_list</span><span class="p">:</span>
                    <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
                    <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

            <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;cat &quot;</span> <span class="o">+</span> <span class="n">profs_path</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">%.3f</span><span class="s2">Hz-temp.Nby2D_tloss_1d.nm&quot;</span> <span class="o">%</span> <span class="n">freq</span>
            <span class="n">command</span> <span class="o">=</span> <span class="n">command</span> <span class="o">+</span> <span class="s2">&quot; &gt;&gt; &quot;</span> <span class="o">+</span> <span class="n">profs_path</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">%.3f</span><span class="s2">Hz.Nby2D_tloss_1d.nm&quot;</span> <span class="o">%</span> <span class="n">freq</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>                    

            <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;cat &quot;</span> <span class="o">+</span> <span class="n">profs_path</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">%.3f</span><span class="s2">Hz-temp.Nby2D_tloss_1d.lossless.nm&quot;</span> <span class="o">%</span> <span class="n">freq</span>
            <span class="n">command</span> <span class="o">=</span> <span class="n">command</span> <span class="o">+</span> <span class="s2">&quot; &gt;&gt; &quot;</span> <span class="o">+</span> <span class="n">profs_path</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">%.3f</span><span class="s2">Hz.Nby2D_tloss_1d.lossless.nm&quot;</span> <span class="o">%</span> <span class="n">freq</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;rm &quot;</span> <span class="o">+</span> <span class="n">profs_path</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">%.3f</span><span class="s2">Hz-temp*&quot;</span> <span class="o">%</span> <span class="n">freq</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Combining transmission loss predictions...&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;cat &quot;</span> <span class="o">+</span> <span class="n">profs_path</span> <span class="o">+</span> <span class="s2">&quot;/*_</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">freq</span> <span class="o">+</span> <span class="s2">&quot;Hz*.nm &gt; &quot;</span> <span class="o">+</span> <span class="n">results_path</span> <span class="o">+</span> <span class="s2">&quot;.nm&quot;</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">keep_lossless</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;cat &quot;</span> <span class="o">+</span> <span class="n">profs_path</span> <span class="o">+</span> <span class="s2">&quot;/*_</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">freq</span> <span class="o">+</span> <span class="s2">&quot;Hz*.lossless.nm &gt; &quot;</span> <span class="o">+</span> <span class="n">results_path</span> <span class="o">+</span> <span class="s2">&quot;.lossless.nm&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">command</span><span class="p">)</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">clean_up</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;rm &quot;</span> <span class="o">+</span> <span class="n">profs_path</span> <span class="o">+</span> <span class="s2">&quot;/*_</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">freq</span> <span class="o">+</span> <span class="s2">&quot;Hz*.lossless.nm&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;rm &quot;</span> <span class="o">+</span> <span class="n">profs_path</span> <span class="o">+</span> <span class="s2">&quot;/*_</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">freq</span> <span class="o">+</span> <span class="s2">&quot;Hz*.nm&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>





<span class="c1"># ############################ #</span>
<span class="c1">#          Stochastic          #</span>
<span class="c1">#      Propagation Models      #</span>
<span class="c1"># ############################ #</span>
<div class="viewcode-block" id="find_azimuth_bin"><a class="viewcode-back" href="../../stochprop.propagation.html#stochprop.propagation.find_azimuth_bin">[docs]</a><span class="k">def</span> <span class="nf">find_azimuth_bin</span><span class="p">(</span><span class="n">az</span><span class="p">,</span> <span class="n">bin_cnt</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Identify the azimuth bin index given some specified number of bins</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        az: float</span>
<span class="sd">            Azimuth in degrees</span>
<span class="sd">        bin_cnt: int</span>
<span class="sd">            Number of bins used in analysis</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        index: int</span>
<span class="sd">            Index of azimuth bin</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># wrap angles to range (-180, 180) degrees</span>
    <span class="n">reduced</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">az</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">az</span><span class="p">))))</span>

    <span class="c1"># Identify the index of the nearest bin</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">180.0</span><span class="p">,</span> <span class="mf">180.0</span><span class="p">,</span> <span class="mf">360.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">bin_cnt</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">reduced</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">result</span><span class="p">[</span><span class="n">result</span> <span class="o">&gt;=</span> <span class="n">bin_cnt</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span></div>


<div class="viewcode-block" id="PathGeometryModel"><a class="viewcode-back" href="../../stochprop.propagation.html#stochprop.propagation.PathGeometryModel">[docs]</a><span class="k">class</span> <span class="nc">PathGeometryModel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Propagation path geometry statistics computed using ray tracing</span>
<span class="sd">        analysis on a suite of specifications includes celerity-range and</span>
<span class="sd">        azimuth deviation/scatter statistics</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_az_bin_cnt</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="n">_rng_max</span> <span class="o">=</span> <span class="mf">1000.0</span>

    <span class="n">_default_az_dev_std</span> <span class="o">=</span> <span class="mf">4.0</span>
    <span class="n">_min_az_dev_std</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="n">_tropo_strat_bnd</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">0.32</span>
    <span class="n">_strat_therm_bnd</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">0.26</span>
    <span class="n">_bnd_overlap</span> <span class="o">=</span> <span class="mf">0.05</span>

    <span class="n">_wts0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0539</span><span class="p">,</span> <span class="mf">0.0899</span><span class="p">,</span> <span class="mf">0.8562</span><span class="p">])</span>
    <span class="n">_std0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.066</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.33</span><span class="p">])</span>
    <span class="n">_mns0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">0.33</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">0.29</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">0.26</span><span class="p">])</span>

    <span class="n">_win_min_pts</span> <span class="o">=</span> <span class="mi">25</span>
    <span class="n">_rcel_std_min</span> <span class="o">=</span> <span class="mf">0.05</span>
    <span class="n">_rcel_wt_min</span> <span class="o">=</span> <span class="mf">1.0e-2</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rngs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_rcel_wts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rcel_mns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rcel_std</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">az_dev_mns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">az_dev_std</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="PathGeometryModel.eval_rcel_gmm"><a class="viewcode-back" href="../../stochprop.propagation.html#stochprop.propagation.PathGeometryModel.eval_rcel_gmm">[docs]</a>    <span class="k">def</span> <span class="nf">eval_rcel_gmm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">rcel</span><span class="p">,</span> <span class="n">az</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Evaluate reciprocal celerity Gaussian Mixture Model (GMM)</span>
<span class="sd">            at specified range, reciprocal celerity, and azimuth</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            rng: float</span>
<span class="sd">                Range from source</span>
<span class="sd">            rcel: float</span>
<span class="sd">                Reciprocal celerity (travel time divided by propagation range)</span>
<span class="sd">            az: float</span>
<span class="sd">                Propagation azimuth (relative to North)</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            pdf: float</span>
<span class="sd">                Probability of observing an infrasonic arrival with specified celerity at specified range and azimuth</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rng_eval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rng</span><span class="p">)</span>
        <span class="n">rng_eval</span><span class="p">[</span><span class="n">rng_eval</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rng_max</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rng_max</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">rng</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">n_az</span> <span class="o">=</span> <span class="n">find_azimuth_bin</span><span class="p">(</span><span class="n">az</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">)</span>
            <span class="n">fit_rcel_wts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f</span><span class="p">(</span><span class="n">rng_eval</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rcel_wts</span><span class="p">[</span><span class="n">n_az</span><span class="p">]])</span>
            <span class="n">fit_rcel_mns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f</span><span class="p">(</span><span class="n">rng_eval</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rcel_mns</span><span class="p">[</span><span class="n">n_az</span><span class="p">]])</span>
            <span class="n">fit_rcel_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f</span><span class="p">(</span><span class="n">rng_eval</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rcel_std</span><span class="p">[</span><span class="n">n_az</span><span class="p">]])</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fit_rcel_wts</span> <span class="o">/</span> <span class="n">fit_rcel_std</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">((</span><span class="n">rcel</span> <span class="o">-</span> <span class="n">fit_rcel_mns</span><span class="p">)</span> <span class="o">/</span> <span class="n">fit_rcel_std</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">rng_eval</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
            <span class="n">vr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">rng_eval</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
            <span class="n">wt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">rng_eval</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>

            <span class="n">az_indices</span> <span class="o">=</span> <span class="n">find_azimuth_bin</span><span class="p">(</span><span class="n">az</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">n_az</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">):</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">az_indices</span> <span class="o">==</span> <span class="n">n_az</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
                    <span class="n">mn</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f</span><span class="p">(</span><span class="n">rng_eval</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rcel_mns</span><span class="p">[</span><span class="n">n_az</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
                    <span class="n">vr</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f</span><span class="p">(</span><span class="n">rng_eval</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rcel_std</span><span class="p">[</span><span class="n">n_az</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
                    <span class="n">wt</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f</span><span class="p">(</span><span class="n">rng_eval</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rcel_wts</span><span class="p">[</span><span class="n">n_az</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">wt</span> <span class="o">/</span> <span class="n">vr</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">rcel</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">mn</span><span class="p">)</span> <span class="o">/</span> <span class="n">vr</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="PathGeometryModel.eval_az_dev_mn"><a class="viewcode-back" href="../../stochprop.propagation.html#stochprop.propagation.PathGeometryModel.eval_az_dev_mn">[docs]</a>    <span class="k">def</span> <span class="nf">eval_az_dev_mn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">az</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Evaluate the mean back azimuth deviation at a given range</span>
<span class="sd">            and propagation azimuth</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            rng: float</span>
<span class="sd">                Range from source</span>
<span class="sd">            az: float</span>
<span class="sd">                Propagation azimuth (relative to North)</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            bias: float</span>
<span class="sd">                Predicted bias in the arrival back azimuth at specified arrival range and azimuth</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">rng</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">az_dev_mns</span><span class="p">[</span><span class="n">find_azimuth_bin</span><span class="p">(</span><span class="n">az</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">)](</span><span class="nb">min</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rng_max</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rng_eval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rng</span><span class="p">)</span>
            <span class="n">rng_eval</span><span class="p">[</span><span class="n">rng_eval</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rng_max</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rng_max</span>
            <span class="n">az_indices</span> <span class="o">=</span> <span class="n">find_azimuth_bin</span><span class="p">(</span><span class="n">az</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">)</span>

            <span class="n">mn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">rng_eval</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">n_az</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">):</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">az_indices</span> <span class="o">==</span> <span class="n">n_az</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
                    <span class="n">mn</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">az_dev_mns</span><span class="p">[</span><span class="n">n_az</span><span class="p">](</span><span class="n">rng_eval</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">mn</span></div>

<div class="viewcode-block" id="PathGeometryModel.eval_az_dev_std"><a class="viewcode-back" href="../../stochprop.propagation.html#stochprop.propagation.PathGeometryModel.eval_az_dev_std">[docs]</a>    <span class="k">def</span> <span class="nf">eval_az_dev_std</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">az</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Evaluate the standard deviation of the back azimuth at a given range</span>
<span class="sd">            and propagation azimuth</span>


<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            rng: float</span>
<span class="sd">                Range from source</span>
<span class="sd">            az: float</span>
<span class="sd">                Propagation azimuth (relative to North)</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            stdev: float</span>
<span class="sd">                Standard deviation of arrival back azimuths at specified range and azimuth</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">rng</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">az_dev_std</span><span class="p">[</span><span class="n">find_azimuth_bin</span><span class="p">(</span><span class="n">az</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">)](</span><span class="nb">min</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rng_max</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rng_eval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rng</span><span class="p">)</span>
            <span class="n">rng_eval</span><span class="p">[</span><span class="n">rng_eval</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rng_max</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rng_max</span>
            <span class="n">az_indices</span> <span class="o">=</span> <span class="n">find_azimuth_bin</span><span class="p">(</span><span class="n">az</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">)</span>

            <span class="n">vr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">rng_eval</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">n_az</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">):</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">az_indices</span> <span class="o">==</span> <span class="n">n_az</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
                    <span class="n">vr</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">az_dev_std</span><span class="p">[</span><span class="n">n_az</span><span class="p">](</span><span class="n">rng_eval</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">vr</span></div>

<div class="viewcode-block" id="PathGeometryModel.build"><a class="viewcode-back" href="../../stochprop.propagation.html#stochprop.propagation.PathGeometryModel.build">[docs]</a>    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arrivals_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">show_fits</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rng_width</span><span class="o">=</span><span class="mf">50.0</span><span class="p">,</span> <span class="n">rng_spacing</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">geom</span><span class="o">=</span><span class="s2">&quot;3d&quot;</span><span class="p">,</span> <span class="n">src_loc</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">min_turning_ht</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">az_bin_cnt</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">az_bin_wdth</span><span class="o">=</span><span class="mf">30.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Construct propagation statistics from a ray tracing arrival file (concatenated from</span>
<span class="sd">            multiple runs most likely) and output a path geometry model</span>


<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            arrivals_file: string</span>
<span class="sd">                Path to file containing infraGA/GeoAc arrival information</span>
<span class="sd">            output_file: string</span>
<span class="sd">                Path to file where results will be saved</span>
<span class="sd">            show_fits: boolean</span>
<span class="sd">                Option ot visualize model construction (for QC purposes)</span>
<span class="sd">            rng_width: float</span>
<span class="sd">                Range bin width in kilometers</span>
<span class="sd">            rng_spacing: float</span>
<span class="sd">                Spacing between range bins in kilometers</span>
<span class="sd">            geom: string</span>
<span class="sd">                Geometry used in infraGA/GeoAc simulation.  Options are &quot;3d&quot; and &quot;sph&quot;</span>
<span class="sd">            src_loc: iterable</span>
<span class="sd">                [x, y, z] or [lat, lon, elev] location of the source used in infraGA/GeoAc simulations.  Note: &#39;3d&#39; simulations assume source at origin.</span>
<span class="sd">            min_turning_ht: float</span>
<span class="sd">                Minimum turning height used to filter out boundary layer paths if not of interest</span>
<span class="sd">            az_bin_cnt: int</span>
<span class="sd">                Number of azimuth bins to use in analysis</span>
<span class="sd">            az_bin_width: float</span>
<span class="sd">                Azimuth bin width in degrees for analysis</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">output_file</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">output_file</span> <span class="o">+</span> <span class="s2">&quot; already exists  ---&gt;  Skipping path geometry model construction...&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="n">geom</span> <span class="o">==</span> <span class="s2">&quot;3d&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">geom</span> <span class="o">==</span> <span class="s2">&quot;sph&quot;</span><span class="p">)):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Incompatible geometry option for infraga: </span><span class="si">{}</span><span class="s2">.  Options are 3d&#39; and &#39;sph&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Building celerity and azimuth statistics from file:&#39;</span><span class="p">,</span> <span class="n">arrivals_file</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span> <span class="o">=</span> <span class="n">az_bin_cnt</span>

                <span class="c1"># define range bins and parameter arrays</span>
                <span class="n">rng_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rng_max</span><span class="p">,</span> <span class="n">rng_spacing</span><span class="p">)</span>
                <span class="n">rng_cnt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rng_bins</span><span class="p">)</span>

                <span class="n">az_dev_mns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">,</span> <span class="n">rng_cnt</span><span class="p">))</span>
                <span class="n">az_dev_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">,</span> <span class="n">rng_cnt</span><span class="p">))</span>

                <span class="n">rcel_wts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">,</span> <span class="n">rng_cnt</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
                <span class="n">rcel_mns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">,</span> <span class="n">rng_cnt</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
                <span class="n">rcel_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">,</span> <span class="n">rng_cnt</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

                <span class="c1"># load infraGA/GeoAc predictions</span>
                <span class="k">if</span> <span class="n">geom</span> <span class="o">==</span> <span class="s2">&quot;3d&quot;</span><span class="p">:</span>
                    <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">cel</span><span class="p">,</span> <span class="n">z_max</span><span class="p">,</span> <span class="n">incl</span><span class="p">,</span> <span class="n">back_az</span><span class="p">,</span> <span class="n">amp_geo</span><span class="p">,</span> <span class="n">amp_atmo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">arrivals_file</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="n">rngs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">az</span> <span class="o">=</span> <span class="mf">90.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
                    <span class="n">az_dev</span> <span class="o">=</span> <span class="p">(</span><span class="mf">90.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="o">-</span><span class="n">y</span><span class="p">,</span> <span class="o">-</span><span class="n">x</span><span class="p">)))</span> <span class="o">-</span> <span class="n">back_az</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">lons</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">cel</span><span class="p">,</span> <span class="n">z_max</span><span class="p">,</span> <span class="n">incl</span><span class="p">,</span> <span class="n">back_az</span><span class="p">,</span> <span class="n">amp_geo</span><span class="p">,</span> <span class="n">amp_atmo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">arrivals_file</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="n">az</span><span class="p">,</span> <span class="n">temp_az</span><span class="p">,</span> <span class="n">rngs</span> <span class="o">=</span> <span class="n">sph_proj</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">src_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">lons</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">src_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">lats</span><span class="p">)),</span> <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">)</span>
                    <span class="n">rngs</span> <span class="o">=</span> <span class="n">rngs</span> <span class="o">/</span> <span class="mf">1000.0</span>
                    <span class="n">az_dev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">temp_az</span><span class="p">)</span> <span class="o">-</span> <span class="n">back_az</span>

                <span class="n">rcel</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">cel</span>

                <span class="c1"># wrap angles to +/- 180 degrees</span>
                <span class="n">phi</span><span class="p">[</span><span class="n">phi</span> <span class="o">&gt;</span> <span class="mf">180.0</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">360.0</span>
                <span class="n">phi</span><span class="p">[</span><span class="n">phi</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">180.0</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">360.0</span>

                <span class="n">az</span><span class="p">[</span><span class="n">az</span> <span class="o">&gt;</span> <span class="mf">180.0</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">360.0</span>
                <span class="n">az</span><span class="p">[</span><span class="n">az</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">180.0</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">360.0</span>

                <span class="n">az_dev</span><span class="p">[</span><span class="n">az_dev</span> <span class="o">&gt;</span> <span class="mf">180.0</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">360.0</span>
                <span class="n">az_dev</span><span class="p">[</span><span class="n">az_dev</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">180.0</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">360.0</span>

                <span class="c1"># Cycle through azimuth bins creating fit</span>
                <span class="n">az_wts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">n_az</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">n_az</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">center</span> <span class="o">=</span> <span class="o">-</span><span class="mf">180.0</span>
                        <span class="n">az_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">az</span> <span class="o">&gt;</span> <span class="mf">180.0</span> <span class="o">-</span> <span class="n">az_bin_wdth</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">az</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">180.0</span> <span class="o">+</span> <span class="n">az_bin_wdth</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">center</span> <span class="o">=</span> <span class="o">-</span><span class="mi">180</span> <span class="o">+</span> <span class="p">(</span><span class="mf">360.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">)</span> <span class="o">*</span> <span class="n">n_az</span>
                        <span class="n">az_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">center</span> <span class="o">-</span> <span class="n">az_bin_wdth</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">&lt;=</span> <span class="n">az</span><span class="p">,</span> <span class="n">az</span> <span class="o">&lt;=</span> <span class="n">center</span> <span class="o">+</span> <span class="n">az_bin_wdth</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>

                    <span class="c1"># combine azimuth and turning height masks</span>
                    <span class="n">az_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">az_mask</span><span class="p">,</span> <span class="n">min_turning_ht</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">z_max</span> <span class="o">-</span> <span class="n">src_loc</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                    <span class="n">az_wts</span><span class="p">[</span><span class="n">n_az</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rngs</span><span class="p">[</span><span class="n">az_mask</span><span class="p">]))</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rngs</span><span class="p">))</span>

                    <span class="c1"># display work if show_fits is enabled</span>
                    <span class="k">if</span> <span class="n">show_fits</span><span class="p">:</span>
                        <span class="n">f</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>

                        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rng_max</span><span class="p">])</span>
                        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">])</span>

                        <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rng_max</span><span class="p">])</span>
                        <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">12.0</span><span class="p">,</span> <span class="mf">12.0</span><span class="p">])</span>

                        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Range [km]&#39;</span><span class="p">)</span>
                        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Celerity [km/s]&#39;</span><span class="p">)</span>

                        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Celerity [km/s]&#39;</span><span class="p">)</span>
                        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Probability&#39;</span><span class="p">)</span>

                        <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Range [km]&#39;</span><span class="p">)</span>
                        <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Azimuth Deviation [degrees]&#39;</span><span class="p">)</span>

                        <span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Azimuth Deviation [degrees]&#39;</span><span class="p">)</span>
                        <span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Probability&#39;</span><span class="p">)</span>

                        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Path Geometry Statistics (&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">center</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rngs</span><span class="p">[</span><span class="n">az_mask</span><span class="p">],</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">rcel</span><span class="p">[</span><span class="n">az_mask</span><span class="p">],</span> <span class="s1">&#39;k.&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
                        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Celerity-range scatter&#39;</span><span class="p">)</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

                        <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rngs</span><span class="p">[</span><span class="n">az_mask</span><span class="p">],</span> <span class="n">az_dev</span><span class="p">[</span><span class="n">az_mask</span><span class="p">],</span> <span class="s1">&#39;k.&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
                        <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Back-azimuth deviation&#39;</span><span class="p">)</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

                    <span class="c1"># Compute fits (1D interpolations of parameters)</span>
                    <span class="n">rng_wts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">rng_cnt</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">nr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rng_cnt</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">show_fits</span><span class="p">:</span>
                            <span class="n">window1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">rng_bins</span><span class="p">[</span><span class="n">nr</span><span class="p">],</span> <span class="n">rng_bins</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">+</span> <span class="n">rng_width</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                            <span class="n">window2</span> <span class="o">=</span> <span class="n">ax3</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">rng_bins</span><span class="p">[</span><span class="n">nr</span><span class="p">],</span> <span class="n">rng_bins</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">+</span> <span class="n">rng_width</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

                        <span class="c1"># define combined azimuth and range mask</span>
                        <span class="n">rng_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">rng_bins</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">rngs</span><span class="p">,</span> <span class="n">rngs</span> <span class="o">&lt;=</span> <span class="n">rng_bins</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">+</span> <span class="n">rng_width</span><span class="p">)</span>
                        <span class="n">rng_az_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">rng_mask</span><span class="p">,</span> <span class="n">az_mask</span><span class="p">)</span>
                        <span class="n">rng_wts</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rngs</span><span class="p">[</span><span class="n">rng_az_mask</span><span class="p">]))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">rngs</span><span class="p">[</span><span class="n">az_mask</span><span class="p">])</span>

                        <span class="c1"># set azimuth deviation fit</span>
                        <span class="k">if</span> <span class="n">az_dev</span><span class="p">[</span><span class="n">rng_az_mask</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_win_min_pts</span><span class="p">:</span>
                            <span class="n">az_dev_mns</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">az_dev</span><span class="p">[</span><span class="n">rng_az_mask</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                            <span class="n">az_dev_std</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">az_dev</span><span class="p">[</span><span class="n">rng_az_mask</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_az_dev_std</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">nr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">az_dev_mns</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                                <span class="n">az_dev_std</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_az_dev_std</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">az_dev_mns</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="n">az_dev_mns</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.75</span>
                                <span class="n">az_dev_std</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_az_dev_std</span> <span class="o">+</span> <span class="p">(</span><span class="n">az_dev_std</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_az_dev_std</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>

                        <span class="c1"># set tropospheric contribution to reciprocal celerity fit</span>
                        <span class="n">combo_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">rng_az_mask</span><span class="p">,</span> <span class="n">rcel</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tropo_strat_bnd</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bnd_overlap</span><span class="p">)</span>

                        <span class="n">wt1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rngs</span><span class="p">[</span><span class="n">combo_mask</span><span class="p">]))</span>
                        <span class="k">if</span> <span class="n">rcel</span><span class="p">[</span><span class="n">combo_mask</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_win_min_pts</span><span class="p">:</span>
                            <span class="n">rcel_mns</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rcel</span><span class="p">[</span><span class="n">combo_mask</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                            <span class="n">rcel_std</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">rcel</span><span class="p">[</span><span class="n">combo_mask</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.25</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rcel_std_min</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">nr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">rcel_mns</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mns0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">rcel_std</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_std0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">rcel_mns</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mns0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">rcel_mns</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mns0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.25</span>
                                <span class="n">rcel_std</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_std0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">rcel_std</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_std0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.25</span>

                        <span class="c1"># set stratospheric contribution to reciprocal celerity fit</span>
                        <span class="n">strat_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tropo_strat_bnd</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bnd_overlap</span> <span class="o">&lt;=</span> <span class="n">rcel</span><span class="p">,</span> <span class="n">rcel</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strat_therm_bnd</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bnd_overlap</span><span class="p">)</span>
                        <span class="n">combo_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">rng_az_mask</span><span class="p">,</span> <span class="n">strat_mask</span><span class="p">)</span>

                        <span class="n">wt2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rngs</span><span class="p">[</span><span class="n">combo_mask</span><span class="p">]))</span>
                        <span class="k">if</span> <span class="n">rcel</span><span class="p">[</span><span class="n">combo_mask</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_win_min_pts</span><span class="p">:</span>
                            <span class="n">rcel_mns</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rcel</span><span class="p">[</span><span class="n">combo_mask</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                            <span class="n">rcel_std</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">rcel</span><span class="p">[</span><span class="n">combo_mask</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.25</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rcel_std_min</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">nr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">rcel_mns</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mns0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                <span class="n">rcel_std</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_std0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">rcel_mns</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mns0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">rcel_mns</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mns0</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.25</span>
                                <span class="n">rcel_std</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_std0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">rcel_std</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_std0</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.25</span>

                        <span class="c1"># set thermospheric contribution to reciprocal celerity fit</span>
                        <span class="n">combo_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">rng_az_mask</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strat_therm_bnd</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bnd_overlap</span> <span class="o">&lt;</span> <span class="n">rcel</span><span class="p">)</span>

                        <span class="n">wt3</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rngs</span><span class="p">[</span><span class="n">combo_mask</span><span class="p">]))</span>
                        <span class="k">if</span> <span class="n">rcel</span><span class="p">[</span><span class="n">combo_mask</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_win_min_pts</span><span class="p">:</span>
                            <span class="n">rcel_mns</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rcel</span><span class="p">[</span><span class="n">combo_mask</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                            <span class="n">rcel_std</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">rcel</span><span class="p">[</span><span class="n">combo_mask</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.25</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rcel_std_min</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">nr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">rcel_mns</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mns0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                <span class="n">rcel_std</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_std0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">rcel_mns</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mns0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">rcel_mns</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mns0</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.25</span>
                                <span class="n">rcel_std</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_std0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">rcel_std</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_std0</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.25</span>

                        <span class="c1"># set weights of reciprocal celerity distribution</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rngs</span><span class="p">[</span><span class="n">rng_az_mask</span><span class="p">])</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_win_min_pts</span><span class="p">:</span>
                            <span class="n">rcel_wts</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">wt1</span> <span class="o">/</span> <span class="p">(</span><span class="n">wt1</span> <span class="o">+</span> <span class="n">wt2</span> <span class="o">+</span> <span class="n">wt3</span><span class="p">)</span>
                            <span class="n">rcel_wts</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">wt2</span> <span class="o">/</span> <span class="p">(</span><span class="n">wt1</span> <span class="o">+</span> <span class="n">wt2</span> <span class="o">+</span> <span class="n">wt3</span><span class="p">)</span>
                            <span class="n">rcel_wts</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">wt3</span> <span class="o">/</span> <span class="p">(</span><span class="n">wt1</span> <span class="o">+</span> <span class="n">wt2</span> <span class="o">+</span> <span class="n">wt3</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">rcel_wts</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>

                        <span class="k">if</span> <span class="n">show_fits</span><span class="p">:</span>
                            <span class="n">ax4</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
                            <span class="n">ax4</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">12.5</span><span class="p">,</span> <span class="mf">12.5</span><span class="p">])</span>
                            <span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">12.5</span><span class="p">,</span> <span class="mf">12.5</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">az_dev_std</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">]</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">12.5</span><span class="p">,</span> <span class="mf">12.5</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">-</span> <span class="n">az_dev_mns</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">])</span> <span class="o">/</span> <span class="n">az_dev_std</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">]),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;Blue&#39;</span><span class="p">)</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

                            <span class="n">cel_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
                            <span class="n">cel_dist1</span> <span class="o">=</span> <span class="p">(</span><span class="n">rcel_wts</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">rngs</span><span class="p">))</span> <span class="o">/</span> <span class="n">rcel_std</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">((</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">cel_vals</span> <span class="o">-</span> <span class="n">rcel_mns</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">rcel_std</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">cel_dist2</span> <span class="o">=</span> <span class="p">(</span><span class="n">rcel_wts</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">rngs</span><span class="p">))</span> <span class="o">/</span> <span class="n">rcel_std</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">((</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">cel_vals</span> <span class="o">-</span> <span class="n">rcel_mns</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">rcel_std</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                            <span class="n">cel_dist3</span> <span class="o">=</span> <span class="p">(</span><span class="n">rcel_wts</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">rngs</span><span class="p">))</span> <span class="o">/</span> <span class="n">rcel_std</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">((</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">cel_vals</span> <span class="o">-</span> <span class="n">rcel_mns</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">rcel_std</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>

                            <span class="n">ax2</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
                            <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">])</span>
                            <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cel_vals</span><span class="p">,</span> <span class="n">cel_dist1</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;Green&#39;</span><span class="p">)</span>
                            <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cel_vals</span><span class="p">,</span> <span class="n">cel_dist2</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;Green&#39;</span><span class="p">)</span>
                            <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cel_vals</span><span class="p">,</span> <span class="n">cel_dist3</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;Green&#39;</span><span class="p">)</span>
                            <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cel_vals</span><span class="p">,</span> <span class="n">cel_dist1</span> <span class="o">+</span> <span class="n">cel_dist2</span> <span class="o">+</span> <span class="n">cel_dist3</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;Blue&#39;</span><span class="p">)</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

                            <span class="n">window1</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
                            <span class="n">window2</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

                    <span class="k">for</span> <span class="n">nr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rng_cnt</span><span class="p">):</span>
                        <span class="n">rcel_wts</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">nr</span><span class="p">]</span> <span class="o">*=</span> <span class="n">rng_wts</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">rng_wts</span><span class="p">)</span>

                    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>

                <span class="c1"># Normalize weights by total arrivals at all azimuths</span>
                <span class="k">for</span> <span class="n">n_az</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">):</span>
                    <span class="n">rcel_wts</span><span class="p">[</span><span class="n">n_az</span><span class="p">]</span> <span class="o">*=</span> <span class="n">az_wts</span><span class="p">[</span><span class="n">n_az</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">az_wts</span><span class="p">)</span>

                <span class="n">priors</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">6</span>
                <span class="n">priors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rng_bins</span>
                <span class="n">priors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">az_dev_mns</span>
                <span class="n">priors</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">az_dev_std</span>
                <span class="n">priors</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">rcel_mns</span>
                <span class="n">priors</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">rcel_std</span>
                <span class="n">priors</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">rcel_wts</span>

                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">priors</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="PathGeometryModel.load"><a class="viewcode-back" href="../../stochprop.propagation.html#stochprop.propagation.PathGeometryModel.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_file</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a path geometry model file for use</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        model_file: string</span>
<span class="sd">            Path to PGM file constructed using stochprop.propagation.PathGeometryModel.build()</span>
<span class="sd">        smooth: boolean</span>
<span class="sd">            Option to use scipy.signal.savgol_filter to smooth discrete GMM parameters along range</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fit_params</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">model_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fit_params</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rng_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">fit_params</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading path geometry model from &quot;</span> <span class="o">+</span> <span class="n">model_file</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Azimuth bin count: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Maximum range: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rng_max</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">az_dev_mns</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">az_dev_std</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_rcel_wts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rcel_mns</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rcel_std</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span>

        <span class="k">for</span> <span class="n">n_az</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rcel_mns</span><span class="p">[</span><span class="n">n_az</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rcel_std</span><span class="p">[</span><span class="n">n_az</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rcel_wts</span><span class="p">[</span><span class="n">n_az</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>

        <span class="k">if</span> <span class="n">smooth</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">n_az</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">az_dev_mns</span><span class="p">[</span><span class="n">n_az</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">fit_params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">savgol_filter</span><span class="p">(</span><span class="n">fit_params</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">n_az</span><span class="p">],</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">az_dev_std</span><span class="p">[</span><span class="n">n_az</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">fit_params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">savgol_filter</span><span class="p">(</span><span class="n">fit_params</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">n_az</span><span class="p">],</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_rcel_mns</span><span class="p">[</span><span class="n">n_az</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rcel_std</span><span class="p">[</span><span class="n">n_az</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rcel_wts</span><span class="p">[</span><span class="n">n_az</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>

                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_rcel_mns</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">fit_params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">savgol_filter</span><span class="p">(</span><span class="n">fit_params</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">n_az</span><span class="p">][:,</span> <span class="n">j</span><span class="p">],</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_rcel_std</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">fit_params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">savgol_filter</span><span class="p">(</span><span class="n">fit_params</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">n_az</span><span class="p">][:,</span> <span class="n">j</span><span class="p">],</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_rcel_wts</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">fit_params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">savgol_filter</span><span class="p">(</span><span class="n">fit_params</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="n">n_az</span><span class="p">][:,</span> <span class="n">j</span><span class="p">],</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">n_az</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">az_dev_mns</span><span class="p">[</span><span class="n">n_az</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">fit_params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fit_params</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">n_az</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">az_dev_std</span><span class="p">[</span><span class="n">n_az</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">fit_params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fit_params</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">n_az</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_rcel_mns</span><span class="p">[</span><span class="n">n_az</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rcel_std</span><span class="p">[</span><span class="n">n_az</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rcel_wts</span><span class="p">[</span><span class="n">n_az</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>

                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_rcel_mns</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">fit_params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fit_params</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">n_az</span><span class="p">][:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_rcel_std</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">fit_params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fit_params</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">n_az</span><span class="p">][:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_rcel_wts</span><span class="p">[</span><span class="n">n_az</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">fit_params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fit_params</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="n">n_az</span><span class="p">][:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PathGeometryModel.display"><a class="viewcode-back" href="../../stochprop.propagation.html#stochprop.propagation.PathGeometryModel.display">[docs]</a>    <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subtitle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show_colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hold_fig</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display the propagation geometry statistics</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_id: string</span>
<span class="sd">            File prefix to save visualization</span>
<span class="sd">        subtitle: string</span>
<span class="sd">            Subtitle used in figures</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">resol</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">rngs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1000.0</span><span class="p">,</span> <span class="n">resol</span><span class="p">)</span>
        <span class="n">bias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">resol</span><span class="p">])</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">resol</span><span class="p">])</span>

        <span class="n">bias_color</span> <span class="o">=</span> <span class="s1">&#39;Blue&#39;</span>
        <span class="n">var_color</span> <span class="o">=</span> <span class="s1">&#39;LightBlue&#39;</span>

        <span class="n">compass_file</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">find_module</span><span class="p">(</span><span class="s1">&#39;stochprop&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/resources/compass.png&#39;</span>

        <span class="n">f1</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">n1</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">n2</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">])</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">750</span><span class="p">,</span> <span class="mi">1000</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">n2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
            <span class="k">if</span> <span class="n">n1</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>

        <span class="n">img</span> <span class="o">=</span> <span class="n">mpimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">compass_file</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Range [km]&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Azimuth Deviation [deg]&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">subtitle</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">((</span><span class="s2">&quot;Azimuth Deviation Statistics&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">subtitle</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Azimuth Deviation Statistics&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">plot_az_stats</span><span class="p">(</span><span class="n">axis_id</span><span class="p">,</span> <span class="n">azimuth</span><span class="p">):</span>
            <span class="n">bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_az_dev_mn</span><span class="p">(</span><span class="n">rngs</span><span class="p">,</span> <span class="p">[</span><span class="n">azimuth</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">rngs</span><span class="p">))</span>
            <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_az_dev_std</span><span class="p">(</span><span class="n">rngs</span><span class="p">,</span> <span class="p">[</span><span class="n">azimuth</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">rngs</span><span class="p">))</span>
            <span class="n">axis_id</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">rngs</span><span class="p">,</span> <span class="n">bias</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">width</span><span class="p">,</span> <span class="n">bias</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">width</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">var_color</span><span class="p">)</span>
            <span class="n">axis_id</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rngs</span><span class="p">,</span> <span class="n">bias</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">bias_color</span><span class="p">)</span>
            <span class="n">axis_id</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rngs</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">rngs</span><span class="p">),</span> <span class="s1">&#39;k:&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="n">plot_az_stats</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mf">45.0</span><span class="p">)</span>
        <span class="n">plot_az_stats</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">plot_az_stats</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="mf">45.0</span><span class="p">)</span>
        <span class="n">plot_az_stats</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mf">90.0</span><span class="p">)</span>
        <span class="n">plot_az_stats</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="mf">90.0</span><span class="p">)</span>
        <span class="n">plot_az_stats</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mf">135.0</span><span class="p">)</span>
        <span class="n">plot_az_stats</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="mf">180.0</span><span class="p">)</span>
        <span class="n">plot_az_stats</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="mf">135.0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">file_id</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">file_id</span> <span class="o">+</span> <span class="s2">&quot;_az-dev.png&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

        <span class="c1"># Plot celerity-range statistics</span>
        <span class="n">cels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="n">resol</span><span class="p">)</span>
        <span class="n">rngs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1000.0</span><span class="p">,</span> <span class="n">resol</span><span class="p">)</span>
        <span class="n">R</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">rngs</span><span class="p">,</span> <span class="n">cels</span><span class="p">)</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="n">pdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">resol</span><span class="p">,</span> <span class="n">resol</span><span class="p">])</span>

        <span class="n">palette</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">nipy_spectral_r</span>

        <span class="n">pdf_max</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">az</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">180.0</span><span class="p">,</span> <span class="mf">180.0</span><span class="p">,</span> <span class="mf">45.0</span><span class="p">):</span>
            <span class="n">pdf_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">pdf_max</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_rcel_gmm</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">V</span><span class="p">,</span> <span class="p">[</span><span class="n">az</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">))))</span>

        <span class="n">f2</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">n1</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">n2</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">])</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">])</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">750</span><span class="p">,</span> <span class="mi">1000</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">n2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
            <span class="k">if</span> <span class="n">n1</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>

        <span class="n">img</span> <span class="o">=</span> <span class="n">mpimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">compass_file</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Range [km]&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Celerity [km/s]&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">subtitle</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">((</span><span class="s2">&quot;Celerity-Range Statistics&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">subtitle</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Celerity-Range Statistics&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">pdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_rcel_gmm</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">V</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">45.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">))</span>
        <span class="n">rngcel_plot</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">pdf</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">palette</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">pdf_max</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">show_colorbar</span><span class="p">:</span>            
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">f1</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">rngcel_plot</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="p">[</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Probability&quot;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span> 

        <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">plot_celerity_stats</span><span class="p">(</span><span class="n">axis_id</span><span class="p">,</span> <span class="n">azimuth</span><span class="p">):</span>
            <span class="n">pdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_rcel_gmm</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">V</span><span class="p">,</span> <span class="p">[</span><span class="n">azimuth</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">))</span>
            <span class="n">axis_id</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">pdf</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">palette</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">pdf_max</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="n">plot_celerity_stats</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">plot_celerity_stats</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="mf">45.0</span><span class="p">)</span>
        <span class="n">plot_celerity_stats</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mf">90.0</span><span class="p">)</span>
        <span class="n">plot_celerity_stats</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="mf">90.0</span><span class="p">)</span>
        <span class="n">plot_celerity_stats</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mf">135.0</span><span class="p">)</span>
        <span class="n">plot_celerity_stats</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="mf">180.0</span><span class="p">)</span>
        <span class="n">plot_celerity_stats</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="mf">135.0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">file_id</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">file_id</span> <span class="o">+</span> <span class="s2">&quot;_cel-rng.png&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">hold_fig</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="TLossModel"><a class="viewcode-back" href="../../stochprop.propagation.html#stochprop.propagation.TLossModel">[docs]</a><span class="k">class</span> <span class="nc">TLossModel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">_az_bin_cnt</span> <span class="o">=</span> <span class="mi">16</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng_vals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tloss_vals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<div class="viewcode-block" id="TLossModel.build"><a class="viewcode-back" href="../../stochprop.propagation.html#stochprop.propagation.TLossModel.build">[docs]</a>    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tloss_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">show_fits</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_coh</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">az_bin_cnt</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">az_bin_wdth</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span> <span class="n">rng_lims</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1000.0</span><span class="p">],</span> <span class="n">rng_cnt</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">rng_smpls</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Construct propagation statistics from a NCPAprop modess or pape file (concatenated from</span>
<span class="sd">            multiple runs most likely) and output a transmission loss model</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            tloss_file: string</span>
<span class="sd">                Path to file containing NCPAprop transmission loss information</span>
<span class="sd">            output_file: string</span>
<span class="sd">                Path to file where results will be saved</span>
<span class="sd">            show_fits: boolean</span>
<span class="sd">                Option ot visualize model construction (for QC purposes)</span>
<span class="sd">            use_coh: boolean</span>
<span class="sd">                Option to use coherent transmission loss</span>
<span class="sd">            az_bin_cnt: int</span>
<span class="sd">                Number of azimuth bins to use in analysis</span>
<span class="sd">            az_bin_width: float</span>
<span class="sd">                Azimuth bin width in degrees for analysis</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">output_file</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">output_file</span> <span class="o">+</span> <span class="s2">&quot; already exists  ---&gt;  Skipping transmission loss model construction...&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Builing transmission loss models from file:&#39;</span><span class="p">,</span> <span class="n">tloss_file</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span> <span class="o">=</span> <span class="n">az_bin_cnt</span>

            <span class="c1"># read in data, convert tloss to dB relative to 1 km, and wrap azimuths to [-180.0:180.0]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Reading in data...&quot;</span><span class="p">)</span>
            <span class="n">rngs</span><span class="p">,</span> <span class="n">az</span><span class="p">,</span> <span class="n">tloss_re</span><span class="p">,</span> <span class="n">tloss_im</span><span class="p">,</span> <span class="n">tloss_coh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">tloss_file</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># output_rngs = np.sort(np.unique(rngs)[::2])</span>
            <span class="k">if</span> <span class="n">rng_smpls</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
                <span class="n">output_rngs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">rng_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rng_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rng_cnt</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output_rngs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rng_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rng_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">rng_cnt</span><span class="p">)</span>

            <span class="n">az</span><span class="p">[</span><span class="n">az</span> <span class="o">&gt;</span> <span class="mf">180.0</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">360.0</span>
            <span class="n">az</span><span class="p">[</span><span class="n">az</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">180.0</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">360.0</span>

            <span class="k">if</span> <span class="n">use_coh</span><span class="p">:</span>
                <span class="n">tloss</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">tloss_coh</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tloss</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tloss_re</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">tloss_im</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
            
            <span class="n">tloss</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isneginf</span><span class="p">(</span><span class="n">tloss</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">tloss</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">tloss</span><span class="p">)])</span>
            <span class="n">tloss</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isposinf</span><span class="p">(</span><span class="n">tloss</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tloss</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">tloss</span><span class="p">)])</span>

            <span class="n">tloss_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">75.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_rngs</span><span class="p">))</span>
            <span class="n">pdf_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_rngs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">tloss_vals</span><span class="p">)))</span>

            <span class="k">for</span> <span class="n">az_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">):</span>
                <span class="n">center</span> <span class="o">=</span> <span class="o">-</span><span class="mi">180</span> <span class="o">+</span> <span class="mf">360.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">az_index</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">az_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">az_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">az</span> <span class="o">&gt;=</span> <span class="mf">180.0</span> <span class="o">-</span> <span class="n">az_bin_wdth</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">az</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mf">180.0</span> <span class="o">+</span> <span class="n">az_bin_wdth</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">az_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">center</span> <span class="o">-</span> <span class="n">az_bin_wdth</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">&lt;=</span> <span class="n">az</span><span class="p">,</span> <span class="n">az</span> <span class="o">&lt;=</span> <span class="n">center</span> <span class="o">+</span> <span class="n">az_bin_wdth</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">show_fits</span><span class="p">:</span>
                    <span class="n">f</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">7.5</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

                    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Range [km]&#39;</span><span class="p">)</span>
                    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Transmission Loss [dB]&#39;</span><span class="p">)</span>
                    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1000.0</span><span class="p">])</span>
                    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">tloss</span><span class="p">)</span> <span class="o">-</span> <span class="mf">5.0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">tloss</span><span class="p">)</span> <span class="o">+</span> <span class="mf">5.0</span><span class="p">])</span>

                    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Range [km]&#39;</span><span class="p">)</span>
                    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Transmission Loss [dB]&#39;</span><span class="p">)</span>
                    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1000.0</span><span class="p">])</span>
                    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">tloss</span><span class="p">)</span> <span class="o">-</span> <span class="mf">5.0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">tloss</span><span class="p">)</span> <span class="o">+</span> <span class="mf">5.0</span><span class="p">])</span>

                    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Stochastic Transmission Loss Model </span><span class="se">\n</span><span class="s2"> Azimuth: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">center</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rngs</span><span class="p">[</span><span class="n">az_mask</span><span class="p">][::</span><span class="mi">11</span><span class="p">],</span> <span class="n">tloss</span><span class="p">[</span><span class="n">az_mask</span><span class="p">][::</span><span class="mi">11</span><span class="p">],</span> <span class="s1">&#39;ko&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>

                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Building statistics for azimuth bin centered at &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">center</span><span class="p">))</span>

                <span class="n">norm_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">az_mask</span><span class="p">,</span> <span class="n">rngs</span> <span class="o">==</span> <span class="nb">min</span><span class="p">(</span><span class="n">rngs</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">use_coh</span><span class="p">:</span>
                    <span class="n">tloss_norm</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tloss_coh</span><span class="p">[</span><span class="n">norm_mask</span><span class="p">])</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="n">rngs</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tloss_norm</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tloss_re</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">tloss_im</span><span class="o">**</span><span class="mi">2</span><span class="p">)[</span><span class="n">norm_mask</span><span class="p">]</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="n">rngs</span><span class="p">)))</span>

                <span class="c1"># Define tloss pdf at each range point from KDE</span>
                <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">rng_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">output_rngs</span><span class="p">):</span>
                    <span class="n">nearest_rng</span> <span class="o">=</span> <span class="n">rngs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">rngs</span> <span class="o">-</span> <span class="n">rng_val</span><span class="p">))]</span>
                    <span class="n">masked_tloss</span> <span class="o">=</span> <span class="n">tloss</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">az_mask</span><span class="p">,</span> <span class="n">rngs</span><span class="o">==</span><span class="n">nearest_rng</span><span class="p">)]</span> <span class="o">-</span> <span class="n">tloss_norm</span>
                    
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">masked_tloss</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
                        <span class="n">pdf_vals</span><span class="p">[</span><span class="n">az_index</span><span class="p">][</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">tloss_vals</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">masked_tloss</span><span class="p">),</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">masked_tloss_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">masked_tloss</span><span class="p">)</span>
                        <span class="n">masked_tloss_stdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">masked_tloss</span><span class="p">)</span>
                        <span class="n">outlier_mask</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">masked_tloss</span> <span class="o">-</span> <span class="n">masked_tloss_mean</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">masked_tloss_stdev</span>

                        <span class="n">kernel</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">(</span><span class="n">masked_tloss</span><span class="p">[</span><span class="n">outlier_mask</span><span class="p">])</span>
                        <span class="n">pdf_vals</span><span class="p">[</span><span class="n">az_index</span><span class="p">][</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">tloss_vals</span><span class="p">)</span>

                    <span class="n">TL1</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">rng_val</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">))</span>
                    <span class="n">TL2</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">rng_val</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">))</span>
                    <span class="n">env_stdev</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">TL1</span> <span class="o">-</span> <span class="n">TL2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
                    <span class="n">envelope</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">tloss_vals</span> <span class="o">-</span> <span class="p">(</span><span class="n">TL1</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">env_stdev</span><span class="p">))</span> <span class="o">/</span> <span class="n">env_stdev</span><span class="p">))</span>
                    <span class="n">pdf_vals</span><span class="p">[</span><span class="n">az_index</span><span class="p">][</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdf_vals</span><span class="p">[</span><span class="n">az_index</span><span class="p">][</span><span class="n">nr</span><span class="p">]</span> <span class="o">*</span> <span class="n">envelope</span>

                    <span class="k">if</span> <span class="n">show_fits</span><span class="p">:</span>
                        <span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">rng_val</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">tloss_vals</span><span class="p">),</span> <span class="n">tloss_vals</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">pdf_vals</span><span class="p">[</span><span class="n">az_index</span><span class="p">][</span><span class="n">nr</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">nipy_spectral_r</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="p">[</span><span class="mf">12.5</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">tloss_vals</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">show_fits</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">priors</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
            <span class="n">priors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_rngs</span>
            <span class="n">priors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tloss_vals</span>
            <span class="n">priors</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdf_vals</span>

            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">priors</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TLossModel.load"><a class="viewcode-back" href="../../stochprop.propagation.html#stochprop.propagation.TLossModel.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_file</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a transmission loss file for use</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        model_file: string</span>
<span class="sd">            Path to TLoss file constructed using stochprop.propagation.TLossModel.build()</span>

<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">fit_params</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">model_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng_vals</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tloss_vals</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fit_params</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading transmission loss model from &quot;</span> <span class="o">+</span> <span class="n">model_file</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Azimuth bin cound: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Maximum range: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng_vals</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pdf_vals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdf_fits</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span>

        <span class="k">for</span> <span class="n">az_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pdf_vals</span><span class="p">[</span><span class="n">az_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">az_index</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pdf_fits</span><span class="p">[</span><span class="n">az_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng_vals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tloss_vals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdf_vals</span><span class="p">[</span><span class="n">az_index</span><span class="p">])</span></div>

<div class="viewcode-block" id="TLossModel.eval"><a class="viewcode-back" href="../../stochprop.propagation.html#stochprop.propagation.TLossModel.eval">[docs]</a>    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">tloss</span><span class="p">,</span> <span class="n">az</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Evaluate TLoss model at specified range, transmission loss, and azimuth</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            rng: float</span>
<span class="sd">                Range from source</span>
<span class="sd">            tloss: float</span>
<span class="sd">                Transmission loss</span>
<span class="sd">            az: float</span>
<span class="sd">                Propagation azimuth (relative to North)</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            pdf: float</span>
<span class="sd">                Probability of observing an infrasonic arrival with specified transmission loss at specified range and azimuth</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">az_index</span> <span class="o">=</span> <span class="n">find_azimuth_bin</span><span class="p">(</span><span class="n">az</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">)</span>

        <span class="n">in_rng_bnds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">rng</span><span class="p">,</span> <span class="n">rng</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng_vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">in_tloss_bnds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tloss_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">tloss</span><span class="p">,</span> <span class="n">tloss</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tloss_vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">in_bnds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">in_rng_bnds</span><span class="p">,</span> <span class="n">in_tloss_bnds</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">rng</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">in_bnds</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdf_fits</span><span class="p">[</span><span class="n">az_index</span><span class="p">]</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="n">tloss</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">rng</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">n_az</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">):</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">in_bnds</span><span class="p">,</span> <span class="n">az_index</span> <span class="o">==</span> <span class="n">n_az</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdf_fits</span><span class="p">[</span><span class="n">n_az</span><span class="p">]</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rng</span><span class="p">)[</span><span class="n">mask</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tloss</span><span class="p">)[</span><span class="n">mask</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="TLossModel.display"><a class="viewcode-back" href="../../stochprop.propagation.html#stochprop.propagation.TLossModel.display">[docs]</a>    <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Transmission Loss Statistics&quot;</span><span class="p">,</span> <span class="n">show_colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hold_fig</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_ref_tloss</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display the transmission loss statistics</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_id: string</span>
<span class="sd">            File prefix to save visualization</span>
<span class="sd">        subtitle: string</span>
<span class="sd">            Subtitle used in figures</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scale_max</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="n">compass_file</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">find_module</span><span class="p">(</span><span class="s1">&#39;stochprop&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/resources/compass.png&#39;</span>

        <span class="n">resol</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">rngs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1000.0</span><span class="p">,</span> <span class="n">resol</span><span class="p">)</span>
        <span class="n">tloss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">60.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">resol</span><span class="p">)</span>

        <span class="n">R</span><span class="p">,</span> <span class="n">TL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">rngs</span><span class="p">,</span> <span class="n">tloss</span><span class="p">)</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">TL</span> <span class="o">=</span> <span class="n">TL</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="n">palette</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">nipy_spectral_r</span>
        <span class="n">f1</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">n1</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">n2</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">tloss</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tloss</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">rngs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rngs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">750</span><span class="p">,</span> <span class="mi">1000</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">n2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
            <span class="k">if</span> <span class="n">n1</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>

        <span class="n">img</span> <span class="o">=</span> <span class="n">mpimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">compass_file</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Range [km]&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Transmission Loss [dB]&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">pdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">TL</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">45.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)))</span>
        <span class="n">tloss_plot</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">TL</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">pdf</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">palette</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="p">[</span><span class="mf">12.5</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">scale_max</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show_ref_tloss</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rngs</span><span class="p">[</span><span class="n">rngs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">],</span> <span class="mf">10.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rngs</span><span class="p">[</span><span class="n">rngs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])),</span> <span class="s1">&#39;--k&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rngs</span><span class="p">[</span><span class="n">rngs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">],</span> <span class="mf">10.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">rngs</span><span class="p">[</span><span class="n">rngs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]),</span> <span class="s1">&#39;-k&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">show_colorbar</span><span class="p">:</span>
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">f1</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">tloss_plot</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="p">[</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Probability&quot;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span> 

        <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">plot_tloss_stats</span><span class="p">(</span><span class="n">axis_id</span><span class="p">,</span> <span class="n">azimuth</span><span class="p">):</span>
            <span class="n">pdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">TL</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">azimuth</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)))</span>
            <span class="n">axis_id</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">TL</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">pdf</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">palette</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="p">[</span><span class="mf">12.5</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">scale_max</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">show_ref_tloss</span><span class="p">:</span>
                <span class="n">axis_id</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rngs</span><span class="p">[</span><span class="n">rngs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">],</span> <span class="mf">10.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rngs</span><span class="p">[</span><span class="n">rngs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])),</span> <span class="s1">&#39;--k&#39;</span><span class="p">)</span>
                <span class="n">axis_id</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rngs</span><span class="p">[</span><span class="n">rngs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">],</span> <span class="mf">10.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">rngs</span><span class="p">[</span><span class="n">rngs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]),</span> <span class="s1">&#39;-k&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

        <span class="n">plot_tloss_stats</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">plot_tloss_stats</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="mf">45.0</span><span class="p">)</span>
        <span class="n">plot_tloss_stats</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mf">90.0</span><span class="p">)</span>
        <span class="n">plot_tloss_stats</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="mf">90.0</span><span class="p">)</span>
        <span class="n">plot_tloss_stats</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mf">135.0</span><span class="p">)</span>
        <span class="n">plot_tloss_stats</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="mf">180.0</span><span class="p">)</span>
        <span class="n">plot_tloss_stats</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="mf">135.0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">file_id</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">file_id</span> <span class="o">+</span> <span class="s2">&quot;_tloss.png&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">hold_fig</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div></div>


<span class="c1">#########################</span>
<span class="c1">##   IMS Noise Model   ## </span>
<span class="c1">#########################</span>
<div class="viewcode-block" id="ims_noise_model"><a class="viewcode-back" href="../../stochprop.propagation.html#stochprop.propagation.ims_noise_model">[docs]</a><span class="k">def</span> <span class="nf">ims_noise_model</span><span class="p">():</span>

    <span class="n">ims_ns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">imp</span><span class="o">.</span><span class="n">find_module</span><span class="p">(</span><span class="s1">&#39;stochprop&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/resources/IMSNOISE_MIN_MED_MAX.txt&#39;</span><span class="p">)</span>
    <span class="n">ns_mean</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">ims_ns</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="mf">10.0</span> <span class="o">*</span> <span class="n">ims_ns</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span>
    <span class="n">ns_sigma</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">ims_ns</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="mf">10.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">ims_ns</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">ims_ns</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ims_ns_pdf</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">array_dim</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">eff_ns_mean</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">ns_mean</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">+</span> <span class="mf">10.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">duration</span> <span class="o">/</span> <span class="n">array_dim</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">eff_ns_mean</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">ns_sigma</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">ims_ns_cdf</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">array_dim</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">eff_ns_mean</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">ns_mean</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">+</span> <span class="mf">10.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">duration</span> <span class="o">/</span> <span class="n">array_dim</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">eff_ns_mean</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">ns_sigma</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">ims_ns_pdf</span><span class="p">,</span> <span class="n">ims_ns_cdf</span></div>



<span class="c1">#########################</span>
<span class="c1">##   Kinney &amp; Graham   ## </span>
<span class="c1">##   Blastwave Model   ##</span>
<span class="c1">#########################</span>
<div class="viewcode-block" id="kg_op"><a class="viewcode-back" href="../../stochprop.propagation.html#stochprop.propagation.kg_op">[docs]</a><span class="k">def</span> <span class="nf">kg_op</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">p_amb</span><span class="o">=</span><span class="mf">101.325</span><span class="p">,</span> <span class="n">T_amb</span><span class="o">=</span><span class="mf">288.15</span><span class="p">,</span> <span class="n">exp_type</span><span class="o">=</span><span class="s2">&quot;chemical&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Kinney &amp; Graham scaling law peak overpressure model</span>
<span class="sd">                </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        W: float</span>
<span class="sd">            Explosive yield of the source [kg eq. TNT]</span>
<span class="sd">        r: float</span>
<span class="sd">            Propagation distance [km]</span>
<span class="sd">        p_amb: float</span>
<span class="sd">            Ambient atmospheric pressure [kPa]</span>
<span class="sd">        T_amb: float</span>
<span class="sd">            Ambient atmospheric temperature [deg K]</span>
<span class="sd">        exp_type: string</span>
<span class="sd">            Type of explosion modeled, options are &quot;chemical&quot; or &quot;nuclear&quot;</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        p0: float</span>
<span class="sd">            Peak overpressure [Pa]    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">fd</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_amb</span> <span class="o">/</span> <span class="mf">101.325</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_amb</span> <span class="o">/</span> <span class="mf">288.15</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">sc_rng</span> <span class="o">=</span> <span class="n">fd</span> <span class="o">/</span> <span class="n">W</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span> <span class="o">*</span> <span class="mf">1000.0</span>
    
    <span class="k">if</span> <span class="n">exp_type</span><span class="o">==</span><span class="s2">&quot;chemical&quot;</span><span class="p">:</span>
        <span class="n">term1</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">sc_rng</span> <span class="o">/</span> <span class="mf">4.5</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">term2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">sc_rng</span> <span class="o">/</span> <span class="mf">0.048</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">term3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">sc_rng</span> <span class="o">/</span> <span class="mf">0.32</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">term4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">sc_rng</span> <span class="o">/</span> <span class="mf">1.35</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="mf">808.0</span> <span class="o">*</span> <span class="n">term1</span> <span class="o">/</span> <span class="p">(</span><span class="n">term2</span> <span class="o">*</span> <span class="n">term3</span> <span class="o">*</span> <span class="n">term4</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">term1</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">sc_rng</span> <span class="o">/</span> <span class="mf">800.0</span><span class="p">)</span>
        <span class="n">term2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">sc_rng</span> <span class="o">/</span> <span class="mf">87.0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="mf">3.2e6</span> <span class="o">/</span> <span class="n">sc_rng</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">term1</span> <span class="o">*</span> <span class="n">term2</span>

    <span class="k">return</span> <span class="n">p_amb</span> <span class="o">*</span> <span class="mf">1.0e3</span> <span class="o">*</span> <span class="n">result</span></div>


<div class="viewcode-block" id="kg_ppd"><a class="viewcode-back" href="../../stochprop.propagation.html#stochprop.propagation.kg_ppd">[docs]</a><span class="k">def</span> <span class="nf">kg_ppd</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">p_amb</span><span class="o">=</span><span class="mf">101.325</span><span class="p">,</span> <span class="n">T_amb</span><span class="o">=</span><span class="mf">288.15</span><span class="p">,</span> <span class="n">exp_type</span><span class="o">=</span><span class="s2">&quot;chemical&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Kinney &amp; Graham scaling law positive phase duration model</span>
<span class="sd">                </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        W : float</span>
<span class="sd">            Explosive yield of the source [kg eq. TNT]</span>
<span class="sd">        r : float</span>
<span class="sd">            Propagation distance [km]</span>
<span class="sd">        p_amb : float</span>
<span class="sd">            Ambient atmospheric pressure [kPa]</span>
<span class="sd">        T_amb : float</span>
<span class="sd">            Ambient atmospheric temperature [deg K]</span>
<span class="sd">        exp_type : string</span>
<span class="sd">            Type of explosion modeled, options are &quot;chemical&quot; or &quot;nuclear&quot;</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        t0 : float</span>
<span class="sd">            Positive phase duration [s]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fd</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_amb</span> <span class="o">/</span> <span class="mf">101.325</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_amb</span> <span class="o">/</span> <span class="mf">288.15</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">sc_rng</span> <span class="o">=</span> <span class="n">fd</span> <span class="o">/</span> <span class="n">W</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span> <span class="o">*</span> <span class="mf">1000.0</span>
    
    <span class="k">if</span> <span class="n">exp_type</span><span class="o">==</span><span class="s2">&quot;chemical&quot;</span><span class="p">:</span>
        <span class="n">term1</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">sc_rng</span> <span class="o">/</span> <span class="mf">0.54</span><span class="p">)</span><span class="o">**</span><span class="mi">10</span>
        <span class="n">term2</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">sc_rng</span> <span class="o">/</span> <span class="mf">0.02</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span>
        <span class="n">term3</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">sc_rng</span> <span class="o">/</span> <span class="mf">0.74</span><span class="p">)</span><span class="o">**</span><span class="mi">6</span>
        <span class="n">term4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">sc_rng</span> <span class="o">/</span> <span class="mf">6.9</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="mf">980.0</span> <span class="o">*</span> <span class="n">term1</span> <span class="o">/</span> <span class="p">(</span><span class="n">term2</span> <span class="o">*</span> <span class="n">term3</span> <span class="o">*</span> <span class="n">term4</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">term1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">sc_rng</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">term2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">sc_rng</span> <span class="o">/</span> <span class="mf">40.0</span><span class="p">))</span>
        <span class="n">term3</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">sc_rng</span> <span class="o">/</span> <span class="mf">285.0</span><span class="p">)</span><span class="o">**</span><span class="mi">5</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">6.0</span><span class="p">)</span>
        <span class="n">term4</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">sc_rng</span> <span class="o">/</span> <span class="mf">50000.0</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">6.0</span><span class="p">)</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="mf">180.0</span> <span class="o">*</span> <span class="n">term1</span> <span class="o">/</span> <span class="p">(</span><span class="n">term2</span> <span class="o">*</span> <span class="n">term3</span> <span class="o">*</span> <span class="n">term4</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span> <span class="o">*</span> <span class="n">W</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e3</span></div>


<div class="viewcode-block" id="blastwave_spectrum"><a class="viewcode-back" href="../../stochprop.propagation.html#stochprop.propagation.blastwave_spectrum">[docs]</a><span class="k">def</span> <span class="nf">blastwave_spectrum</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">p_amb</span><span class="o">=</span><span class="mf">101.325</span><span class="p">,</span> <span class="n">T_amb</span><span class="o">=</span><span class="mf">288.15</span><span class="p">,</span> <span class="n">exp_type</span><span class="o">=</span><span class="s2">&quot;chemical&quot;</span><span class="p">,</span> <span class="n">shaping_param</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Fourier transform amplitude for the acoustic</span>
<span class="sd">            blastwave in sasm.acoustic.blastwave().</span>
<span class="sd">        </span>
<span class="sd">        Note: shaping_param = 0 produces the Friedlander</span>
<span class="sd">        blastwave model.</span>
<span class="sd">        </span>
<span class="sd">        Note: the peak of the spectrum occurs at</span>
<span class="sd">        f_0 = \frac{1}{2 \pi t_0} \frac{1}{\sqrt{\alpha + 1}</span>
<span class="sd">        and t0 corresponding to a given peak frequency is</span>
<span class="sd">        t_0 = \frac{1}{2 \pi f_0} \frac{1}{\sqrt{\alpha + 1}</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        f: float</span>
<span class="sd">            Frequency [Hz]</span>
<span class="sd">        W: float</span>
<span class="sd">            Explosive yield of the source [kg eq. TNT]</span>
<span class="sd">        r: float</span>
<span class="sd">            Propagation distance [km]</span>
<span class="sd">        p_amb: float</span>
<span class="sd">            Ambient atmospheric pressure [kPa]</span>
<span class="sd">        T_amb: float</span>
<span class="sd">            Ambient atmospheric temperature [deg K]</span>
<span class="sd">        exp_type: string</span>
<span class="sd">            Type of explosion modeled, options are &quot;chemical&quot; or &quot;nuclear&quot;</span>
<span class="sd">        shaping_param: float</span>
<span class="sd">            Shaping parameter for waveform that controls high frequency trend (set to 0 for original Friedlander blastwave)</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        P : float</span>
<span class="sd">            Spectral value at frequency f</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">p0</span> <span class="o">=</span> <span class="n">kg_op</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">p_amb</span><span class="p">,</span> <span class="n">T_amb</span><span class="p">,</span> <span class="n">exp_type</span><span class="p">)</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">kg_ppd</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">p_amb</span><span class="p">,</span> <span class="n">T_amb</span><span class="p">,</span> <span class="n">exp_type</span><span class="p">)</span>

    <span class="n">omega</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">f</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">shaping_param</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">shaping_param</span><span class="p">)</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">x0</span><span class="o">**</span><span class="n">shaping_param</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">x0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">shaping_param</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">p0</span> <span class="o">/</span> <span class="n">norm</span> <span class="o">*</span> <span class="n">t0</span> <span class="o">*</span> <span class="n">gamma</span><span class="p">(</span><span class="n">shaping_param</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">omega</span> <span class="o">*</span> <span class="n">t0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">omega</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">t0</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="n">shaping_param</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span></div>


<span class="c1"># ############################# #</span>
<span class="c1">#      Detection Capbility      #</span>
<span class="c1">#     &amp; Network Performance     #</span>
<span class="c1"># ############################# #</span>
<div class="viewcode-block" id="plot_detection_stats"><a class="viewcode-back" href="../../stochprop.propagation.html#stochprop.propagation.plot_detection_stats">[docs]</a><span class="k">def</span> <span class="nf">plot_detection_stats</span><span class="p">(</span><span class="n">tlms</span><span class="p">,</span> <span class="n">yld_vals</span><span class="p">,</span> <span class="n">array_dim</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show_fig</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">})</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">ims_ns_cdf</span> <span class="o">=</span> <span class="n">ims_noise_model</span><span class="p">()</span>

    <span class="n">P_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">50.0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mf">10.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">blastwave_spectrum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tlms</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">yld_vals</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">)))</span> <span class="o">+</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>

    <span class="n">fig_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">tlms</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">yld_vals</span><span class="p">))</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">yld_vals</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">tlms</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">fig_size</span><span class="p">,</span> <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;projection&#39;</span><span class="p">:</span> <span class="s1">&#39;polar&#39;</span><span class="p">})</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">yld_vals</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Computing detection statistics for surface explosion with yield &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">yld_vals</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.0e-3</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; tons eq TNT...&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tlms</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Analyzing TLM at &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tlms</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">n</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; Hz...&quot;</span><span class="p">)</span>
            <span class="n">tlm_freq</span> <span class="o">=</span> <span class="n">tlms</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">n</span><span class="p">]</span>
            <span class="n">tlm</span> <span class="o">=</span> <span class="n">tlms</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">n</span><span class="p">]</span>
            <span class="n">src0</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">blastwave_spectrum</span><span class="p">(</span><span class="n">tlm_freq</span><span class="p">,</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">yld_vals</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">))</span>
   
            <span class="n">rng_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">tlm</span><span class="o">.</span><span class="n">rng_vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">dr</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rng_vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">rng_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">P_grid</span><span class="p">,</span> <span class="n">rng_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">P_vals</span><span class="p">,</span> <span class="n">rng_vals</span><span class="p">)</span>

            <span class="n">duration</span> <span class="o">=</span> <span class="n">rng_grid</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.34</span> <span class="o">-</span> <span class="mf">0.27</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.34</span> <span class="o">*</span> <span class="mf">0.27</span><span class="p">)</span>
            <span class="n">duration</span><span class="p">[</span><span class="n">duration</span> <span class="o">&lt;</span> <span class="mf">5.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">5.0</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">yld_vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tlms</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ax_j</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">n</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">yld_vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ax_j</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax_j</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>

            <span class="n">ax_j</span><span class="o">.</span><span class="n">set_theta_direction</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax_j</span><span class="o">.</span><span class="n">set_theta_zero_location</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">)</span>

            <span class="n">ax_j</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
            <span class="n">ax_j</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">tlm</span><span class="o">.</span><span class="n">rng_vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax_j</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax_j</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
                <span class="n">ax_j</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>

            <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;black&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ax_j</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()]</span>
            <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax_j</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tlm_freq</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; Hz&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.075</span><span class="p">,</span> <span class="mf">0.925</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax_j</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">yld_vals</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.0e-3</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; tons&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.075</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">az_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tlm</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">):</span>
                <span class="n">center</span> <span class="o">=</span> <span class="o">-</span><span class="mi">180</span> <span class="o">+</span> <span class="mf">360.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">az_index</span> <span class="o">/</span> <span class="n">tlm</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">)</span>
                <span class="n">arrival</span> <span class="o">=</span> <span class="n">tlm</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">rng_grid</span><span class="p">,</span> <span class="n">P_grid</span> <span class="o">-</span> <span class="n">src0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">rng_grid</span><span class="p">)</span> <span class="o">*</span> <span class="n">center</span><span class="p">)</span>
                <span class="n">rng_prob</span> <span class="o">=</span> <span class="n">simps</span><span class="p">(</span><span class="n">arrival</span> <span class="o">*</span> <span class="n">ims_ns_cdf</span><span class="p">(</span><span class="n">P_grid</span><span class="p">,</span> <span class="n">tlm_freq</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">,</span> <span class="n">array_dim</span><span class="o">=</span><span class="n">array_dim</span><span class="p">),</span> <span class="n">P_vals</span><span class="p">)</span>

                <span class="n">im</span> <span class="o">=</span> <span class="n">ax_j</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">center</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">rng_vals</span><span class="p">))),</span> <span class="n">width</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mf">360.0</span> <span class="o">/</span> <span class="n">tlm</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">),</span> <span class="n">height</span><span class="o">=</span><span class="n">dr</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="n">rng_vals</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">hot_r</span><span class="p">(</span><span class="n">rng_prob</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
                        
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Plotting detection statistics...&quot;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">yld_vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">yld_vals</span><span class="p">)):</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
            <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>


    <span class="n">cax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([(</span><span class="nb">len</span><span class="p">(</span><span class="n">tlms</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tlms</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">),</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">])</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">ColorbarBase</span><span class="p">(</span><span class="n">cax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">hot_r</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Detection Probability&quot;</span><span class="p">)</span>


    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">output_path</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_path</span> <span class="o">+</span> <span class="s2">&quot;.det-stats.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span> 
    
    <span class="k">if</span> <span class="n">show_fig</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="plot_network_performance"><a class="viewcode-back" href="../../stochprop.propagation.html#stochprop.propagation.plot_network_performance">[docs]</a><span class="k">def</span> <span class="nf">plot_network_performance</span><span class="p">(</span><span class="n">info_file</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">W0</span><span class="p">,</span> <span class="n">det_cnt_min</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span><span class="p">,</span> <span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">resol</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">show_fig</span><span class="p">):</span>

    <span class="c1"># Extract network locations and unique TLM/dim info</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading network info from &quot;</span> <span class="o">+</span> <span class="n">info_file</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">sta_locs</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">model_files</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">info_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">of</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;()[]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">sta_locs</span> <span class="o">=</span> <span class="n">sta_locs</span> <span class="o">+</span> <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">temp</span><span class="p">[:</span><span class="mi">2</span><span class="p">]]]</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="n">dims</span> <span class="o">+</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">temp</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
            <span class="n">model_files</span> <span class="o">=</span> <span class="n">model_files</span> <span class="o">+</span> <span class="p">[</span><span class="n">temp</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>

    <span class="n">sta_locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sta_locs</span><span class="p">)</span>
    <span class="n">dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span>

    <span class="c1"># Loop over unique TLM/dim combinations, build PDF(r, az) interpolation, and evaluate on the grid</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">ims_ns_cdf</span> <span class="o">=</span> <span class="n">ims_noise_model</span><span class="p">()</span>

    <span class="c1"># check if frequency value is in TLM file name(s):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">model_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;Hz&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning!  Couldn&#39;t extract frequency from TLM file name(s).  Using specified value (&quot;</span> <span class="o">+</span> <span class="n">freq</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing spectral amplitude for source:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Yield: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">W0</span> <span class="o">*</span> <span class="mf">1.0e-3</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; ton eq. TNT&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Frequency: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; Hz&quot;</span><span class="p">)</span>

    <span class="n">src0</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">blastwave_spectrum</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">W0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
    <span class="n">P_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">50.0</span><span class="p">,</span> <span class="n">src0</span> <span class="o">+</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>

    <span class="n">lat_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span><span class="p">,</span> <span class="n">resol</span><span class="p">)</span>
    <span class="n">lon_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">resol</span><span class="p">)</span>

    <span class="n">grid_lats</span><span class="p">,</span> <span class="n">grid_lons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">lat_vals</span><span class="p">,</span> <span class="n">lon_vals</span><span class="p">)</span>
    <span class="n">grid_lats</span> <span class="o">=</span> <span class="n">grid_lats</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">grid_lons</span> <span class="o">=</span> <span class="n">grid_lons</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Evaluating detection statistics for each station...&quot;</span><span class="p">)</span>
    <span class="n">det_stats</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">model_info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model_files</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Loading TLM from &#39;&quot;</span> <span class="o">+</span> <span class="n">model_info</span> <span class="o">+</span> <span class="s2">&quot;&#39; for station at (&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sta_locs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sta_locs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>

        <span class="n">tlm</span> <span class="o">=</span> <span class="n">TLossModel</span><span class="p">()</span>
        <span class="n">tlm</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_info</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">rng_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">tlm</span><span class="o">.</span><span class="n">rng_vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">P_grid</span><span class="p">,</span> <span class="n">rng_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">P_vals</span><span class="p">,</span> <span class="n">rng_vals</span><span class="p">)</span>

        <span class="n">duration</span> <span class="o">=</span> <span class="n">rng_grid</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.34</span> <span class="o">-</span> <span class="mf">0.27</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.34</span> <span class="o">*</span> <span class="mf">0.27</span><span class="p">)</span>
        <span class="n">duration</span><span class="p">[</span><span class="n">duration</span> <span class="o">&lt;</span> <span class="mf">2.5</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.5</span>
        
        <span class="n">det_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">rng_vals</span><span class="p">),</span> <span class="n">tlm</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">az_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tlm</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">):</span>
            <span class="n">center</span> <span class="o">=</span> <span class="o">-</span><span class="mi">180</span> <span class="o">+</span> <span class="mf">360.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">az_index</span> <span class="o">/</span> <span class="n">tlm</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">)</span>
            <span class="n">arrival</span> <span class="o">=</span> <span class="n">tlm</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">rng_grid</span><span class="p">,</span> <span class="n">P_grid</span> <span class="o">-</span> <span class="n">src0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">rng_grid</span><span class="p">)</span> <span class="o">*</span> <span class="n">center</span><span class="p">)</span>
            <span class="n">det_prob</span><span class="p">[:,</span> <span class="n">az_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">simps</span><span class="p">(</span><span class="n">arrival</span> <span class="o">*</span> <span class="n">ims_ns_cdf</span><span class="p">(</span><span class="n">P_grid</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">,</span> <span class="n">array_dim</span><span class="o">=</span><span class="n">dims</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span> <span class="n">P_vals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">az_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">180</span> <span class="o">+</span> <span class="mf">360.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">j</span> <span class="o">/</span> <span class="n">tlm</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tlm</span><span class="o">.</span><span class="n">_az_bin_cnt</span><span class="p">)])</span>
        <span class="n">az_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">az_vals</span><span class="p">,</span> <span class="mf">180.0</span><span class="p">)</span>
        <span class="n">det_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">det_prob</span><span class="p">,</span> <span class="n">det_prob</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>

        <span class="n">interp</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">rng_vals</span><span class="p">,</span> <span class="n">az_vals</span><span class="p">,</span> <span class="n">det_prob</span><span class="p">)</span>

        <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sph_proj</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">sta_locs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">grid_lons</span><span class="p">),</span> <span class="n">sta_locs</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">grid_lats</span><span class="p">),</span> <span class="n">grid_lons</span><span class="p">,</span> <span class="n">grid_lats</span><span class="p">,</span> <span class="n">radians</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="n">output_azs</span><span class="p">,</span> <span class="n">output_rngs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">temp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mf">180.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">temp</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mf">1000.0</span>

        <span class="n">output_azs</span><span class="p">[</span><span class="n">output_azs</span> <span class="o">&gt;</span> <span class="mf">180.0</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">360.0</span>
        <span class="n">output_azs</span><span class="p">[</span><span class="n">output_azs</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">180.0</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">360.0</span>

        <span class="n">output_rngs</span><span class="p">[</span><span class="n">output_rngs</span> <span class="o">&lt;</span> <span class="mf">5.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">5.0</span>

        <span class="n">det_stats</span> <span class="o">=</span> <span class="n">det_stats</span> <span class="o">+</span> <span class="p">[</span><span class="n">interp</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="n">output_rngs</span><span class="p">,</span> <span class="n">output_azs</span><span class="p">)]</span>
   
    <span class="n">det_stats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">det_stats</span><span class="p">)</span>

    <span class="c1"># Combine statistics and generate map</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Combining station detection stats to determine network performance...&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;Requiring &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">det_cnt_min</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; detecting stations.&quot;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">det_stats</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">det_cnt_min</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">indices</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sta_locs</span><span class="p">))),</span> <span class="n">r</span><span class="o">=</span><span class="n">n</span><span class="p">):</span>
            <span class="n">P1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">det_stats</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">det_stats</span><span class="p">))</span> <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">])</span>
            <span class="n">P2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">det_stats</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">det_stats</span><span class="p">))</span> <span class="k">if</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">])</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">P1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">P2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">map_proj</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span><span class="p">)</span>

    <span class="n">gl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="p">(</span><span class="n">crs</span><span class="o">=</span><span class="n">map_proj</span><span class="p">,</span> <span class="n">draw_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
    <span class="n">gl</span><span class="o">.</span><span class="n">top_labels</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">gl</span><span class="o">.</span><span class="n">right_labels</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">lat_tick</span><span class="p">,</span> <span class="n">lon_tick</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">lat_max</span> <span class="o">-</span> <span class="n">lat_min</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span><span class="p">),</span> <span class="nb">int</span><span class="p">((</span><span class="n">lon_max</span> <span class="o">-</span> <span class="n">lon_min</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">gl</span><span class="o">.</span><span class="n">xlocator</span> <span class="o">=</span> <span class="n">mticker</span><span class="o">.</span><span class="n">FixedLocator</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lon_min</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">lon_tick</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="n">lon_max</span> <span class="o">+</span> <span class="n">lon_tick</span><span class="p">,</span> <span class="n">lon_tick</span><span class="p">))</span>
    <span class="n">gl</span><span class="o">.</span><span class="n">ylocator</span> <span class="o">=</span> <span class="n">mticker</span><span class="o">.</span><span class="n">FixedLocator</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lat_min</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">lat_tick</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="n">lat_max</span> <span class="o">+</span> <span class="n">lat_tick</span><span class="p">,</span> <span class="n">lat_tick</span><span class="p">))</span>
    <span class="n">gl</span><span class="o">.</span><span class="n">xformatter</span> <span class="o">=</span> <span class="n">LONGITUDE_FORMATTER</span>
    <span class="n">gl</span><span class="o">.</span><span class="n">yformatter</span> <span class="o">=</span> <span class="n">LATITUDE_FORMATTER</span>

    <span class="c1"># Add features (coast lines, borders)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">COASTLINE</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lon_max</span> <span class="o">-</span> <span class="n">lon_min</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">20.0</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">STATES</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">RIVERS</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;dodgerblue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAKES</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;dodgerblue&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;dodgerblue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="n">sc</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">grid_lons</span><span class="p">,</span> <span class="n">grid_lats</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">result</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">YlOrRd</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sta_locs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">sta_locs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;^k&quot;</span><span class="p">)</span>

    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">ax_cb</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">new_horizontal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="s2">&quot;5%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">axes_class</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">(</span><span class="n">ax_cb</span><span class="p">)</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">ax_cb</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Detection Probability&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">output_path</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_path</span> <span class="o">+</span> <span class="s2">&quot;.network.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span> 
    
    <span class="k">if</span> <span class="n">show_fig</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Philip Blom.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>